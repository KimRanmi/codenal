<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">

<th:block layout:fragment="pagetitle">
	<div th:replace="partials/title-meta :: title-meta('File Manager')"></div>
</th:block>

<head>
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body>
	<div layout:fragment="content">
		<div class="chat-wrapper d-lg-flex gap-1 mx-n4 mt-n4 p-1">
			<div class="file-manager-sidebar">
				<div class="p-3 d-flex flex-column h-100">
					<div class="mb-3">
						<h5 class="mb-0 fw-semibold">문서함</h5>
					</div>
					<div class="search-box">
						<input type="text" class="form-control bg-light border-light"
							placeholder="Search here..."> <i
							class="ri-search-2-line search-icon"></i>
					</div>
					<div class="mt-3 mx-n4 px-4 file-menu-sidebar-scroll"
						data-simplebar>
						<ul class="list-unstyled file-manager-menu">
							<li>
								<button class="btn" data-bs-toggle="collapse"
									href="#collapseExample" role="button" aria-expanded="true"
									aria-controls="collapseExample">
									<i class="ri-folder-2-line align-bottom me-2"></i> <span
										class="file-list-link">문서함</span>
								</button>
								<div class="collapse show" id="collapseExample">
									<ul class="sub-menu list-unstyled">
										<li><a href="/apps-file-manager">개인문서</a></li>
										<li><a href="#!">공유문서</a></li>
									</ul>
								</div>
							</li>
							<li><a href="#!"><i
									class="ri-star-line align-bottom me-2"></i> <span
									class="file-list-link">즐겨찾기</span></a></li>
							<li><a href="#!"><i
									class="ri-delete-bin-line align-bottom me-2"></i> <span
									class="file-list-link">휴지통</span></a></li>
						</ul>
					</div>
					<div class="mt-auto">
						<h6 class="fs-11 text-muted text-uppercase mb-3">저장 용량</h6>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-database-2-line fs-17"></i>
							</div>
							<div class="flex-grow-1 ms-3 overflow-hidden">
								<div class="progress mb-2 progress-sm">
									<div class="progress-bar bg-success" role="progressbar"
										style="width: 25%" aria-valuenow="25" aria-valuemin="0"
										aria-valuemax="100"></div>
								</div>
								<span class="text-muted fs-12 d-block text-truncate"><b>47.52</b>GB
									used of <b>119</b>GB</span>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="file-manager-content w-100 p-3 py-0">
				<div class="mx-n3 pt-4 px-4 file-manager-content-scroll"
					data-simplebar>
					<div id="folder-list" class="mb-2">
						<div class="row justify-content-between g-2 mb-3">
							<div class="col">
								<div class="d-flex align-items-center">
									<div class="flex-shrink-0 me-2 d-block d-lg-none">
										<button type="button"
											class="btn btn-soft-success btn-icon btn-sm fs-16 file-menu-btn">
											<i class="ri-menu-2-fill align-bottom"></i>
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div>
						<div class="d-flex align-items-center mb-3">
							<h5 class="flex-grow-1 fs-16 mb-0" id="filetype-title">개인 문서</h5>
							<div class="ms-auto">
								<!-- 등록 버튼을 오른쪽 끝으로 이동 -->
								<button type="button" class="btn btn-primary"
									onclick="openFileDialog()">파일 등록</button>

								<!-- 숨겨진 파일 입력 -->
								<input type="file" id="fileInput" style="display: none;"
									onchange="uploadFile()">
							</div>
						</div>
					</div>
					<div class="table-responsive">
						<table class="table align-middle table-nowrap mb-0">
							<thead class="table-active">
								<tr>
									<th scope="col">파일명</th>
									<th scope="col">크기</th>
									<th scope="col">생성일</th>
									<th scope="col">공유여부</th>
									<th scope="col" class="text-center">세부</th>
								</tr>
							</thead>
							<tbody id="file-list"></tbody>
						</table>
					</div>
					<ul id="pagination" class="pagination pagination-lg"></ul>
					<div
						class="align-items-center mt-2 row g-3 text-center text-sm-start">
						<div class="col-sm">
							<div class="text-muted">
								Showing <span class="fw-semibold">4</span> of <span
									class="fw-semibold">125</span> Results
							</div>
						</div>
						<div class="col-sm-auto">
							<ul
								class="pagination pagination-separated pagination-sm justify-content-center justify-content-sm-start mb-0">
								<li class="page-item disabled"><a href="#"
									class="page-link">←</a></li>
								<li class="page-item"><a href="#" class="page-link">1</a></li>
								<li class="page-item active"><a href="#" class="page-link">2</a></li>
								<li class="page-item"><a href="#" class="page-link">3</a></li>
								<li class="page-item"><a href="#" class="page-link">→</a></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<th:block layout:fragment="pagejs">
		<!-- apexcharts -->
		<script src="/assets/libs/apexcharts/apexcharts.min.js"></script>
		<script src="/assets/js/pages/file-manager.init.js"></script>
		<script>
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');

        function openFileDialog() {
            document.getElementById('fileInput').click();
        }

        // 파일 업로드 처리
        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            fetch('/api/documents/upload', {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': csrfToken
                },
                body: formData
            })
            .then(response => response.text())
            .then(result => {
                alert(result);
                // 성공 후 파일 목록 갱신
                fetchFileList();
            })
            .catch(error => {
                console.error('Error uploading file:', error);
            });
        }
		
        	
        function formatFileSize(bytes) {
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 Byte';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        }
        
        // 문서 목록 가져오기
        function fetchFileList() {
            fetch('/api/documents/list')
                .then(response => response.json())
                .then(data => {
                    const fileList = document.getElementById('file-list');
                    fileList.innerHTML = ''; // 기존 목록을 지우고 새 목록을 추가

                    data.forEach(document => {
                    	const formattedSize = formatFileSize(document.docSize);
                        const row = `
                            <tr>
                                <td>${document.docName}</td>
                                <td>${formattedSize}</td>
                                <td>${new Date(document.docCreatedDate).toLocaleDateString()}</td>
                                <td>${document.docStatus == 1 ? '공유' : '개인'}</td>
                                <td class="text-center"><button class="btn btn-info btn-sm">보기</button></td>
                            </tr>
                        `;
                        fileList.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching file list:', error);
                });
        }

        // 페이지 로드 시 문서 목록 가져오기
        document.addEventListener('DOMContentLoaded', fetchFileList);
     
    </script>
	</th:block>
</body>
</html>
