<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
    <!-- Meta and Bootstrap CSS -->
    <meta charset="UTF-8">
    <title>전자결재 등록</title>
    <!-- Bootstrap CSS -->
    <th:block layout:fragment="pagetitle" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Dropzone CSS -->
    <link href="/assets/libs/dropzone/dropzone.css" rel="stylesheet" type="text/css" />
    <!-- 토슽 api -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <style>
        #modal {
            position: fixed;
            display: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            background-color: white;
            border: 1px solid #b9b9b9;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            box-sizing: border-box;
            overflow: hidden;
        }
        .modal-content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            height: calc(100% - 60px); /* 버튼 영역을 제외한 공간 */
            box-sizing: border-box;
            overflow-y: auto;
        }
        .modal-item {
            border: 1px solid #b9b9b9;
            width: 20px;
            height: 20px;
            display: contents;
            align-items: center;
            justify-content: center;
            margin: 5px;
            cursor: pointer;
            user-select: none;
        }
        .modal-item.selected {
            color: cornflowerblue;
        }
        .modal-footer {
            display: flex;
            justify-content: center;
            padding: 10px;
            border-top: 1px solid #b9b9b9;
        }
        .modal-item.disabled {
            color: #b9b9b9;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div th:replace="partials/page-title :: page-title('전자결재 작성', '전자결재')"></div>
        <div class="row" style="margin-left:30px;">
            <div class="col-lg-8">
                <div style="background-color:white; width:1300px; height:1150px;">
                    <div style="margin-left:50px; margin-top:-20px;">
                        <form>
                        <br>
                        <div class="mb-3" style="width:600px;">
                            <label class="form-label" for="project-title-input">제목</label>
                            <input type="text" class="form-control" id="project-title-input" placeholder="제목을 입력하세요" style="width:500px;">
                        </div>
                        <div class="mb-3" style="width:600px;">
                            <label class="form-label" for="project-author-input">기안자</label>
                            <input type="text" class="form-control" id="project-author-input" disabled style="width:500px;">
                        </div>
                        <div class="mb-3" style="width:600px;">
                            <label class="form-label" for="project-date-input">기안일</label>
                            <input type="text" class="form-control" id="project-date-input" disabled style="width:500px;">
                        </div>
                        <div class="mb-3" style="width:600px;">
                            <label class="form-label" for="project-thumbnail-img">파일첨부</label>
                            <input class="form-control" id="project-thumbnail-img" type="file" accept="image/png, image/gif, image/jpeg" style="width:500px;">
                        </div>
                        <div class="mb-3">
					        <label class="form-label" for="references">수신참조자</label><br>
					        <input id="references" type="text" style="width:500px; height:35px; border:1px solid #d3d3d3; border-radius:4px;" class="selectedName3">
    					</div>
                        <div class="mb-3" style="width:600px;">
                            <label class="form-label" for="project-thumbnail-img">양식</label><br>
                            <select class="form-control" id="project-thumbnail-img" style="width:500px;">
                            	<option></option>
                            	<option></option>
                            	<option></option>
                            </select>
                        </div>
                        <br>
                        <!-- 토스트 api -->
                        <div class="col-lg-8" style="margin-left : -15px;">
    						<label>내용</label>
        					<div id="approval_edit"></div>
						</div>
                        <!-- Buttons -->
                        <br>
                        <div style="margin-left:950px;">
                            <button type="submit" class="btn btn-secondary w-sm">올리기</button>
                            <button type="submit" class="btn btn-danger w-sm">취소</button>
                        </div>
                        <!-- Sign-off and Approval Tables -->
                        <div style="margin-top:-1048px; margin-left:600px;">
                        
                        <label>합의자</label>  
					    <table style="border-collapse: collapse; border-bottom: 1px solid #d3d3d3; margin-bottom: -1px;">
					        <tr>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align:center;"></td>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align:center;">
					                <input type="button" value="선택" style="background-color:white; border:white;" id="button_modal1">
					            </td>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align:center;"></td>
					        </tr>
					    </table>
					    <table style="border-collapse: collapse; border-spacing: 0;">
					        <tr>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;" class="selectedName"></td>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;" class="selectedName"></td>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;" class="selectedName"></td>
					        </tr>
					    </table>
					    <br>
					    
					    <label>결재자</label> 
					    <table style="border-collapse: collapse; border-bottom: 1px solid #d3d3d3; margin-bottom: -1px;">
					        <tr>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align:center;"></td>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align:center;">
					                <div style="display:none" class="modal2">
					                    <label>직원 선택</label>
					                </div>
					                <input type="button" value="선택" style="background-color:white; border:white;" id="button_modal2">
					            </td>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align:center;"></td>
					        </tr>
					    </table>
					    <table style="border-collapse: collapse; border-spacing: 0;">
					        <tr>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;" class="selectedName2"></td>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;" class="selectedName2"></td>
					            <td style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;" class="selectedName2"></td>
					        </tr>
					    </table>
                        </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- 모달 창 -->
		    <div id="modal">
		        <div style="text-align: center;">결재자 선택</div>
		        <div class="modal-content"> <!-- 이건 불러오는 값 ! 미리 내가 설정해놓은 것  -->
		            <div class="modal-item">이과장</div>
		            <div class="modal-item">박과장</div>
		            <div class="modal-item">김과장</div>
		            <div class="modal-item">최과장</div>
		            <!-- 추가적인 사람들 -->
		        </div>
		        <div class="modal-footer">
		            <button id="selectButton" style="background-color: cadetblue; border: 0px; border-radius: 30px; ">선택</button>
		            <button id="closeButton" style="background-color: red; border: 0px; border-radius: 30px;">닫기</button>
		        </div>
		    </div>
        </div>
	    <script> /* 토스트 api 설정 */
		       const contentEditor = new toastui.Editor({
		       el: document.querySelector('#approval_edit'),
		       width: '100%',
		       height: '500px',
		       initialEditType: 'wysiwyg',
		       previewStyle: 'vertical',
		       hideModeSwitch: true
    		});
    	</script>
    	
    	
    	<!-- 모달 관련 script -->
    	<script>
	        const modal = document.querySelector('#modal');
	        const button = document.querySelector('#button_modal1');
	        const button2 = document.querySelector('#button_modal2');
	        const button3 = document.querySelector('#references');
	        const closeButton = document.querySelector('#closeButton');
	        const selectButton = document.querySelector('#selectButton');
	        const selectedNames = document.querySelectorAll('.selectedName');
	        const selectedNames2 = document.querySelectorAll('.selectedName2');
	        const selectedNames3 = document.querySelector('#references');
	        let selectedPeople = []; //합의자
	        let selectedPeople2 = []; //결재자
	        let selectedPeople3 = []; //수신 참조자

	        function updateModal() {
	            const group = modal.dataset.group;
	            const modalItems = document.querySelectorAll('.modal-item');
	
	            modalItems.forEach(item => {
	                const person = item.textContent.trim();
	                let isDisabled = false;
	
	                if (group === 'approver') {
	                    // 결재자 모달에서는 선택된 합의자만 비활성화
	                    isDisabled = selectedPeople.includes(person) || selectedPeople3.includes(person);
	                } else if (group === 'agreement') {
	                    // 합의자 모달에서는 선택된 결재자 및 수신참조자 비활성화
	                    isDisabled = selectedPeople2.includes(person) || selectedPeople3.includes(person);
	                } else if (group === 'references') {
	                    // 수신참조자 모달에서는 선택된 결재자 및 합의자 비활성화
	                    isDisabled = selectedPeople.includes(person) || selectedPeople2.includes(person);
	                }
	
	                item.classList.toggle('disabled', isDisabled);
	            });
	        }
	        
       		// 합의자 모달 열기
	        button.addEventListener('click', () => {
	            modal.style.display = 'block';
	            modal.dataset.group = 'agreement';
	            updateModal();
	        });

	        // 결재자 모달 열기
	        button2.addEventListener('click', () => {
	            modal.style.display = 'block';
	            modal.dataset.group = 'approver';
	            updateModal();
	        });

	        // 수신참조자 모달 열기
	        button3.addEventListener('click', () => {
	            modal.style.display = 'block';
	            modal.dataset.group = 'references';
	            updateModal();
	        });


	        // 모달 닫기
	        closeButton.addEventListener('click', () => {
	            modal.style.display = 'none';
	        });

	        // 선택된 사람 저장
	        document.querySelectorAll('.modal-item').forEach(item => {
	            item.addEventListener('click', () => {
	                const person = item.textContent.trim();
	                const group = modal.dataset.group;
	
	                if (item.classList.contains('disabled')) {
	                    return;  // disabled 상태이면 아무 동작도 하지 않음
	                }
	
	                if(group === 'approver'){
	                    if (selectedPeople2.includes(person)) {
	                        // 이미 선택된 사람을 해제
	                        selectedPeople2 = selectedPeople2.filter(p => p !== person);
	                        item.classList.remove('selected');
	                    } else if (selectedPeople2.length < 3) {
	                        // 선택된 사람이 3명 이하인 경우에만 추가
	                        selectedPeople2.push(person);
	                        item.classList.add('selected');
	                    } else {
	                        // 선택된 사람 수가 3명 이상일 경우 경고
	                        alert('최대 3명까지 선택할 수 있습니다.');
	                    }
	
	                }else if(group === 'agreement'){
	                    if (selectedPeople.includes(person)) {
	                        // 이미 선택된 사람을 해제
	                        selectedPeople = selectedPeople.filter(p => p !== person);
	                        item.classList.remove('selected');
	                    } else if (selectedPeople.length < 3) {
	                        // 선택된 사람이 3명 이하인 경우에만 추가
	                        selectedPeople.push(person);
	                        item.classList.add('selected');
	                    } else {
	                        // 선택된 사람 수가 3명 이상일 경우 경고
	                        alert('최대 3명까지 선택할 수 있습니다.');
	                    }
	                }else if(group === 'references'){
	                    if (selectedPeople3.includes(person)) {
	                        // 이미 선택된 사람을 해제
	                        selectedPeople3 = selectedPeople3.filter(p => p !== person);
	                        item.classList.remove('selected');
	                    } else{
	                        selectedPeople3.push(person);
	                        item.classList.add('selected');
	                    }
	                }
	            });
	        });
        
	        // 적용 버튼 클릭 시 선택된 사람을 페이지에 반영
	        selectButton.addEventListener('click', () => {
	            const group = modal.dataset.group;
	
	            if (group === 'agreement') {
	                selectedNames.forEach((element, index) => {
	                    element.textContent = selectedPeople[index] || '';
	                    button.value = '';
	                });
	            } else if (group === 'approver') {
	                selectedNames2.forEach((element, index) => {
	                    element.textContent = selectedPeople2[index] || '';
	                    button2.value= '';
	                });
	            } else if ( group === 'references') {
	                selectedNames3.value = selectedPeople3.join(', ');
	            }
	
	            modal.style.display = 'none';
	        });
    	</script>
    </div>
</body>
</html>
