<!doctype html>
<<<<<<< HEAD
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}" data-sidebar="light">
=======
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
>>>>>>> branch 'develop' of https://github.com/KimRanmi/codenal.git
<head>
<meta charset="UTF-8">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<title>전자결재 등록</title>

<th:block layout:fragment="pagetitle" />

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link href="/assets/libs/dropzone/dropzone.css" rel="stylesheet"
	type="text/css" />
<link rel="stylesheet"
	href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />

<style>
.jstree-icon.ri-building-fill {
	color: #3e4a6e;
	font-size: 24px;
}

.jstree-icon.ri-team-fill {
	color: #3577f1;
	font-size: 20px;
}

.jstree-icon.ri-user-2-fill {
	color: #9a9ba0;
	font-size: 16px;
}

</style>

</head>
<body>
	<div layout:fragment="content">
		<div th:replace="partials/page-title :: page-title('전자결재 작성', '전자결재')"></div>
		<div class="row">
			<div class="col-lg-12">
				<div style="background-color: white; width: 1750px; height: 1150px;"
					id="classDiv">
					<div style="margin-left: 50px; margin-top: -20px;">
						<form id="approvalForm" method="POST">
							<input type="hidden" id="csrf_token" th:value="${_csrf.token}" />
							<br>
							<div class="mb-3" style="width: 600px;">
								<label class="form-label" for="project-title-input">제목</label> <input
									type="text" class="form-control" id="project-title-input"
									placeholder="제목을 입력하세요" style="width: 500px;"
									name="approval_title">
							</div>
							<div class="mb-3" style="width: 600px;">
								<label class="form-label" for="project-author-input">기안자</label>
								<input type="text" class="form-control"
									th:value="${#authentication.name}" id="emp_id"
									readonly style="width: 500px;" name="emp_id">
							</div>
							<div class="mb-3" style="width: 600px;">
								<label class="form-label" for="project-date-input">기안일</label> <input
									type="text" class="form-control" id="project-date-input"
									th:value="${ldt}" readonly style="width: 500px;"
									name="approval_reg_date">
							</div>
							<div class="mb-3" style="width: 600px;">
								<label class="form-label" for="project-thumbnail-img">파일첨부</label>
								<input class="form-control" id="project-thumbnail-img"
									name="file" type="file"
									accept="image/png, image/gif, image/jpeg" style="width: 500px;">
							</div>

							<div class="mb-3">
								<label class="form-label" for="references">수신참조자</label><br>
								<input id="references" type="text"
									style="width: 500px; height: 35px; border: 1px solid #d3d3d3; border-radius: 4px;"
									class="selectedName3">
							</div>
							<div class="mb-3" style="width: 600px;">
								<label class="form-label" for="project-thumbnail-img">양식</label><br>
								<div th:if="${no == 2}">
									<select class="form-control" id="category-select"
										style="width: 500px;" name="form_code"
										onchange="updateEditorContent()">
										<option>-- 선택하세요 --</option>
										<option th:each="cate : ${cateList}"
											th:text="${cate.form_name}" id="cateList"
											th:value="${cate.form_code}"
											th:data-content="${cate.form_content}"></option>
									</select>
								</div>
								<div th:if="${no == 3}">
									<select class="form-control" id="category-select"
										style="width: 500px;" name="form_code"
										onchange="updateEditorContent()">
										<option>-- 선택하세요 --</option>
										<option th:each="cate : ${cateList}"
											th:value="${cate.form_code}" th:text="${cate.form_name}"
											id="cateList" th:data-content="${cate.form_content}">
										</option>
									</select>
								</div>
							</div>
							<br>
							<div class="col-lg-11" style="margin-left: -15px;">
								<label>내용</label>
								<div id="approval_edit" name="approval_content"></div>
							</div>
							<br>
							<div style="margin-left: 1350px; margin-top: 30px;">
								<button type="submit" class="btn btn-secondary w-sm">올리기</button>
								<button type="button" class="btn btn-danger w-sm"
									onclick="history.back()">취소</button>
							</div>

							<!-- 모달 생성 -->
							<div class="modal fade" id="staticBackdrop"
								data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
								role="dialog" aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered" role="document">
									<div class="modal-content">
										<div class="modal-body text-left">
											<div class="mt-1">
												<h4 class="mb-3">직원 등록</h4>
												<div id="treeMenu"></div>
												<div id="treeAdd"></div>
												<div class="hstack gap-9">
													<a id="successBtn" class="btn btn-success">완료</a> <a
														href="javascript:void(0);"
														class="btn btn-link link-success fw-medium"
														data-bs-dismiss="modal"><i
														class="ri-close-line me-1 align-middle" id="resetBtn"></i>초기화</a>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- 합의자, 결재자 선택  -->
							<div style="margin-top: -1080px; margin-left: 900px;">
								<label>합의자</label>
								<table
									style="border-collapse: collapse; border-bottom: 1px solid #d3d3d3; margin-bottom: -1px;" data-name="">
									<tr>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;">
											<button type="button" class="btn btn-primary"
												style="background-color: white; color: black; border: 1px solid white;"
												id="button_modal1">선택</button>

										</td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;"></td>
									</tr>
								</table>
								<table style="border-collapse: collapse; border-spacing: 0;">
									<tr>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName" data-group="agree"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName" data-group="agree"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName" data-group="agree"></td>
									</tr>
								</table>
								<br> <label>결재자</label>
								<table
									style="border-collapse: collapse; border-bottom: 1px solid #d3d3d3; margin-bottom: -1px;">
									<tr>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;">
											<button type="button" class="btn btn-primary"
												style="background-color: white; color: black; border: 1px solid white;"
												id="button_modal2">선택</button>

										</td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;"></td>
									</tr>
								</table>
								<table style="border-collapse: collapse; border-spacing: 0;">
									<tr>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName2" data-group="approver"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName2" data-group="approver"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName2" data-group="approver"></td>
									</tr>
								</table>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script
			src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
		<script
			src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>



		<!-- 모달 관련 js -->
			<script>
			
			// 로그인 한 사람 은 트리구조에서 지우기 
			const loginId = document.getElementById('emp_id').value;
		    const selectArray = []; // 선택된 이름을 저장할 배열
		    let buttonId = '';
		    
		    $('#button_modal1, #button_modal2').click(function() {
		        console.log('모달이 열렸습니다.'); // 모달 열림 로그
		        buttonId = this.id;
		        console.log(buttonId);
		        
		        // 선택 배열 초기화
		        selectArray.length = 0; 
		
		        $.ajax({
		            url: '/approval/modal', // 데이터를 가져올 URL
		            method: 'GET',
		            dataType: 'json',
		            success: function(data) {
		                console.log(data); // 데이터 로그
		
		                // jsTree용 데이터 형식 변환. 지금 로그인한 사람 정보는 제외
		                const formatDataForJsTree = (nodes) => {
		                    return nodes
		                    .filter(node => node.nodeId.toString() !== loginId)
		                    .map(node => ({
		                        id: node.nodeId,
		                        text: node.nodeName,
		                        state: { opened: false },
		                        children: node.nodeChildren ? formatDataForJsTree(node.nodeChildren) : [],
		                        icon: node.nodeChildren && node.nodeChildren.length > 0 ? 'ri-team-fill' : 'ri-user-2-fill'
		                    }));
						
		                };
		                const formattedData = formatDataForJsTree(data);
		                const formattedDataLength = formattedData.length; 
		                const companyNode = {
		                    id: 'companyName',
		                    text: 'withXwork',
		                    state: { opened: true },
		                    children: formattedData,
		                    icon: 'ri-building-fill'
		                };
		
		                // 기존 jsTree 인스턴스 제거
		                if ($('#treeMenu').data('jstree')) {
		                    $('#treeMenu').jstree("destroy");
		                }
		
		                // jsTree 초기화
		                $('#treeMenu').jstree({
		                    'core': {
		                        animation: 0,
		                        check_callback: false,
		                        data: [companyNode]
		                    },
		                    plugins: ["types", "selectbox"],
		                    types: {
		                        default: { icon: "ri-team-fill" },
		                        file: { icon: "ri-user-2-fill" }
		                    }
		                }).on('select_node.jstree', function(e, data) {
		                    const selectedNodes = $('#treeMenu').jstree("get_selected", true);
		                    selectArray.length = 0; // 배열 초기화
		
		                    selectedNodes.forEach(node => {
		                        if (node.parent !== 'companyName') {
		                            selectArray.push({id: node.id, text: node.text}); // 선택된 자식 노드의 이름 추가, 데이터 베이스에 보낼 id 설정
		                            console.log(node);
		                        }
		                    });
		                });
		
		                // 모달 표시
		                const modalElement = document.getElementById('staticBackdrop');
		                if (modalElement) {
		                    const modal = new bootstrap.Modal(modalElement, {
		                        backdrop: 'static',
		                        keyboard: false // ESC로 닫기 방지
		                    });
		                    modal.show(); // 모달 표시
		                    
		                    // 등록 버튼 이벤트
		                    $(document).on('click', '#successBtn', function() {
		                        const selectNameElements = buttonId === "button_modal1" 
		                            ? document.querySelectorAll('.selectedName') 
		                            : document.querySelectorAll('.selectedName2');
		
		                            const length = Math.min(selectNameElements.length, selectArray.length); // 최소 길이

		                            for (let index = 0; index < length; index++) {
		                                // selectArray[index]가 정의되어 있는지 확인
		                                if (selectArray[index]) {
		                                    selectNameElements[index].textContent = selectArray[index].text; // 선택된 이름 설정
		                                    selectNameElements[index].setAttribute('data-name', selectArray[index].id); // data-name 설정
		                                } else {
		                                    selectNameElements[index].textContent = ''; // 비워두기
		                                    selectNameElements[index].removeAttribute('data-name'); // data-name 제거
		                                }
		                            }
		
		                        modal.hide(); // 모달 닫기
		                    });
		
		                 // 초기화 버튼 이벤트 -> 이건 나중에 수정
		                    $(document).on('click', '#resetBtn', function() {
		                        const selectNameElements = buttonId === "button_modal1" 
		                            ? document.querySelectorAll('.selectedName') 
		                            : document.querySelectorAll('.selectedName2');

		                        selectNameElements.forEach((element) => {
		                            if (element) { // 요소가 존재하는지 확인
		                                element.innerHTML = ''; // 비워두기
		                            } else {
		                                console.warn("해당 요소가 존재하지 않습니다."); // 요소가 없을 때 경고 로그
		                            }
		                        });
		                        selectArray.length = 0; // 배열 초기화
		                    });
		                } else {
		                    console.error("모달 요소를 찾을 수 없습니다.");
		                }
		            }
		        });
		    });
		</script>

		<!-- 폼 안에 필요한 값 불러오기 -->
		<script>
        
        const contentEditor = new toastui.Editor({
            el: document.querySelector('#approval_edit'),
            width: '100%',
            height: '500px',
            initialEditType: 'wysiwyg',
            previewStyle: 'vertical',
            hideModeSwitch: true
        });
        
        function updateEditorContent() {
            const selectElement = document.getElementById('category-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const formContent = selectedOption.getAttribute('data-content');

            // 토스트 에디터 내용 저장한 값 불러옴
            contentEditor.setHTML(formContent);
        }

        // 페이지 로드 시 기본 내용 설정
        document.addEventListener('DOMContentLoaded', () => {
            updateEditorContent();
        });

        const form = document.getElementById("approvalForm");
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const payload = new FormData(form);
            const csrfToken = document.getElementById('csrf_token').value;
            
            /* const divs = document.querySelectorAll('td[data-group="agree"]'); // 'agree' 그룹의 td 요소 선택
            const groupA = []; // 결과를 저장할 배열 초기화

            for (let i = 0; i < divs.length; i++) {
                const div = divs[i]; // 각 div 요소 가져오기
                const numberValue = Number(div); // 숫자로 변환

                if (!isNaN(numberValue)) { // 숫자인지 확인
                    groupA.push(numberValue); // 숫자로 변환한 값 추가
                }
            }
            
            console.log(groupA);
             */ 
             
             // 위의 코드랑 같은 것. 짧게 생성 map은 자바스크립트의 배열 메서드 중 하나
             const agree = Array.from(document.querySelectorAll('td[data-group="agree"]'))
             .map(td => {
             	const value = td.getAttribute('data-name');
             	return value ? Number(value) : null;
             })
              .filter(Boolean);
             
             
             const approver = Array.from(document.querySelectorAll('td[data-group="approver"]'))
             .map(td => {
            	 const value = td.getAttribute('data-name');
            	 return value ? Number(value) : null;
             })
             .filter(Boolean);

            /* 토스트 api 안에 값 저장 */
            const content = contentEditor.getHTML();
            
            payload.append("approval_content", content);
			payload.append("agree", agree);
			payload.append("approver",approver);
            
			payload.forEach((value, key) => {
			    console.log(`${key}: ${value}`);
			});
			
			fetch('/approval', {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': csrfToken
                },
                body: payload 
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.res_msg);
                if (data.res_code === '200') {
                    Swal.fire({
                        icon: 'success',
                        title: "성공",
                        text: data.res_msg
                    }).then(() => {
                        location.href = "/approval/list?num=0";
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '실패',
                        text: data.res_msg
                    });
                }
            });
        });
    </script>
	</div>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script
		src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

</body>
</html>