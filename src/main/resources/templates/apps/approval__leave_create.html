<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<!-- Meta and Bootstrap CSS -->
<meta charset="UTF-8">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<title>전자결재 등록(휴가신청서)</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link href="/assets/libs/dropzone/dropzone.css" rel="stylesheet"
	type="text/css" />
<link rel="stylesheet"
	href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
<style>
.jstree-icon.ri-building-fill {
	color: #3e4a6e;
	font-size: 24px;
}

.jstree-icon.ri-team-fill {
	color: #3577f1;
	font-size: 20px;
}

.jstree-icon.ri-user-2-fill {
	color: #9a9ba0;
	font-size: 16px;
}

select, input[type=date] {
	border: 1px solid #d3d3d3;
	border-radius: 4px;
	height: 35px;
}
</style>
</head>
<body>
	<div layout:fragment="content">
		<div th:replace="partials/page-title :: page-title('전자결재 작성', '전자결재')"></div>
		<div class="row" style="margin-left: 30px;">
			<div class="col-lg-12">
				<div style="background-color: white; width: 1750px; height: 1250px;">
					<div style="margin-left: 50px; margin-top: -20px;">
						<form id="approvalForm">
							<input type="hidden" id="csrf_token" th:value="${_csrf.token}" />
							<br>
							<div class="mb-3" style="width: 600px;">
								<label class="form-label" for="project-title-input">제목</label> <input
									type="text" class="form-control" id="project-title-input"
									placeholder="제목을 입력하세요" style="width: 500px;"
									name="approval_title">
							</div>
							<div class="mb-3" style="width: 600px;">
								<label class="form-label" for="project-author-input">기안자</label>
								<input type="text" class="form-control"
									th:value="${#authentication.name}" id="emp_id"
									readonly style="width: 500px;" name="emp_id">
							</div>
							<div class="mb-3" style="width: 600px;">
								<label class="form-label" for="project-date-input">기안일</label> <input
									type="text" class="form-control" id="project-date-input"
									th:value="${ldt}" readonly style="width: 500px;"
									name="approval_reg_date">
							</div>
							<div class="mb-3" style="width: 600px;">
								<label class="form-label" for="project-thumbnail-img">파일첨부</label>
								<input class="form-control" id="project-thumbnail-img"
									name="file" type="file"
									accept="image/png, image/gif, image/jpeg" style="width: 500px;">
							</div>
							<div class="mb-3">
								<label class="form-label" for="references">수신참조자</label><br>
								<input id="references" type="text"
									style="width: 500px; height: 35px; border: 1px solid #d3d3d3; border-radius: 4px;"
									class="selectedName3">
							</div>

							<!-- 양식 선택 -->
							<div class="mb-3" style="width: 600px;">
								<label class="form-label" for="project-thumbnail-img">양식</label><br>
								<!-- 근태신청서의 경우 -->
								<div th:if="${no == 1}">
									<select class="form-control" id="category-select"
										style="width: 200px;" name="form_code"
										onchange="updateEditorContent()">
										<option>-- 선택하세요 --</option>
										<option th:each="cate : ${cateList}"
											th:text="${cate.form_name}" id="cateList"
											th:value="${cate.form_code}"
											th:data-content="${cate.form_content}"></option>
									</select>
									<div
										style="margin-top: -30px; margin-left: 230px; color: #b9b9b9">
										내 잔여연차 : <span th:text="${remainDay}"></span>
									</div>

									<div style="margin-top: 30px; margin-bottom: 10px;">날짜</div>
									<div id="dateContent" style="width: 1000px;">
										<input type="date" style="width: 200px;" id="startDate">
										<select style="margin-left: 10px; width: 150px;"
											name="time_period">
											<option>오전</option>
											<option>오후</option>
										</select>
									</div>
								</div>
							</div>
							<br>
							<!-- 토스트 api -->
							<div class="col-lg-11" style="margin-left: -15px;">
								<label>내용</label>
								<div id="approval_edit"></div>
							</div>
							<!-- 버튼 -->
							<br>
							<div style="margin-left: 1350px; margin-top: 30px;">
								<button type="submit" class="btn btn-secondary w-sm">올리기</button>
								<button type="submit" class="btn btn-danger w-sm"
									onclick="history.back()">취소</button>
							</div>
							
							<!-- 모달 생성 -->
							<div class="modal fade" id="staticBackdrop"
								data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
								role="dialog" aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered" role="document">
									<div class="modal-content">
										<div class="modal-body text-left">
											<div class="mt-1">
												<h4 class="mb-3">직원 등록</h4>
												<div id="treeMenu"></div>
												<div id="treeAdd"></div>
												<div class="hstack gap-9">
													<a id="successBtn" class="btn btn-success">완료</a> <a
														href="javascript:void(0);"
														class="btn btn-link link-success fw-medium"
														data-bs-dismiss="modal"><i
														class="ri-close-line me-1 align-middle" id="resetBtn"></i>초기화</a>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>

							<div style="margin-top: -1150px; margin-left: 900px;">

								<!-- 합의자 결재자 선택 -->
								<label>합의자</label>
								<table
									style="border-collapse: collapse; border-bottom: 1px solid #d3d3d3; margin-bottom: -1px;">
									<tr>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;">
											<input type="button" value="선택"
											style="background-color: white; border: white;"
											id="button_modal1">
										</td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;"></td>
									</tr>
								</table>
								<table style="border-collapse: collapse; border-spacing: 0;">
									<tr>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName"></td>
									</tr>
								</table>
								<br> <label>결재자</label>
								<table
									style="border-collapse: collapse; border-bottom: 1px solid #d3d3d3; margin-bottom: -1px;">
									<tr>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;">
											<div style="display: none" class="modal2">
												<label>직원 선택</label>
											</div> <input type="button" value="선택"
											style="background-color: white; border: white;"
											id="button_modal2">
										</td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 130px; text-align: center;"></td>
									</tr>
								</table>
								<table style="border-collapse: collapse; border-spacing: 0;">
									<tr>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName2"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName2"></td>
										<td
											style="border: 1px solid #d3d3d3; width: 180px; height: 30px; text-align: center;"
											class="selectedName2"></td>
									</tr>
								</table>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script
			src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
		<script
			src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>

		<!-- 모달 관련 js -->
		<script>
		const loginId = document.getElementById('emp_id');
	    const selectArray = []; // 선택된 이름을 저장할 배열
	    let buttonId = '';
	
	    $('#button_modal1, #button_modal2').click(function() {
	        console.log('모달이 열렸습니다.'); // 모달 열림 로그
	        buttonId = this.id;
	        console.log(buttonId);
	        
	        // 선택 배열 초기화
	        selectArray.length = 0; 
	
	        $.ajax({
	            url: '/approval/modal', // 데이터를 가져올 URL
	            method: 'GET',
	            dataType: 'json',
	            success: function(data) {
	                console.log(data); // 데이터 로그
	
	                // jsTree용 데이터 형식 변환
	                const formatDataForJsTree = (nodes) => {
	                    return nodes
	                    .filter(node => node.nodeId !== loginId)
	                    .map(node => ({
	                        id: node.nodeId,
	                        text: node.nodeName,
	                        state: { opened: false },
	                        children: node.nodeChildren ? formatDataForJsTree(node.nodeChildren) : [],
	                        icon: node.nodeChildren && node.nodeChildren.length > 0 ? 'ri-team-fill' : 'ri-user-2-fill'
	                    }));
	                };
	
	                const formattedData = formatDataForJsTree(data);
	                const companyNode = {
	                    id: 'companyName',
	                    text: 'withXwork',
	                    state: { opened: true },
	                    children: formattedData,
	                    icon: 'ri-building-fill'
	                };
	
	                // 기존 jsTree 인스턴스 제거
	                if ($('#treeMenu').data('jstree')) {
	                    $('#treeMenu').jstree("destroy");
	                }
	
	                // jsTree 초기화
	                $('#treeMenu').jstree({
	                    'core': {
	                        animation: 0,
	                        check_callback: false,
	                        data: [companyNode]
	                    },
	                    plugins: ["types", "selectbox"],
	                    types: {
	                        default: { icon: "ri-team-fill" },
	                        file: { icon: "ri-user-2-fill" }
	                    }
	                }).on('select_node.jstree', function(e, data) {
	                    const selectedNodes = $('#treeMenu').jstree("get_selected", true);
	                    selectArray.length = 0; // 배열 초기화
	
	                    selectedNodes.forEach(node => {
	                        if (node.parent !== 'companyName') {
	                            selectArray.push(node.text); // 선택된 자식 노드의 이름 추가
	                            console.log(node.text); // 자식 노드 이름 출력
	                        }
	                    });
	                });
	
	                // 모달 표시
	                const modalElement = document.getElementById('staticBackdrop');
	                if (modalElement) {
	                    const modal = new bootstrap.Modal(modalElement, {
	                        backdrop: 'static',
	                        keyboard: false // ESC로 닫기 방지
	                    });
	                    modal.show(); // 모달 표시
	                    
	                    // 등록 버튼 이벤트
	                    $(document).on('click', '#successBtn', function() {
	                        const selectNameElements = buttonId === "button_modal1" 
	                            ? document.querySelectorAll('.selectedName') 
	                            : document.querySelectorAll('.selectedName2');
	
	                        selectNameElements.forEach((element, index) => {
	                            element.textContent = selectArray[index] // 선택된 이름 또는 비워두기
	                        });
	
	                        modal.hide(); // 모달 닫기
	                    });
	
	                 // 초기화 버튼 이벤트 -> 이건 나중에 수정
	                    $(document).on('click', '#resetBtn', function() {
	                        const selectNameElements = buttonId === "button_modal1" 
	                            ? document.querySelectorAll('.selectedName') 
	                            : document.querySelectorAll('.selectedName2');

	                        selectNameElements.forEach((element) => {
	                            if (element) { // 요소가 존재하는지 확인
	                                element.innerHTML = ''; // 비워두기
	                            } else {
	                                console.warn("해당 요소가 존재하지 않습니다."); // 요소가 없을 때 경고 로그
	                            }
	                        });
	                        selectArray.length = 0; // 배열 초기화
	                    });
	                } else {
	                    console.error("모달 요소를 찾을 수 없습니다.");
	                }
	            }
	        });
	    });
	</script>



		<!-- 날짜 생성 스크립트 설정 -->
		<script>
                const select = document.getElementById('category-select');
                const content = document.getElementById('dateContent');
            
                // select 값이 변경될 때마다 실행되는 이벤트 리스너
                select.addEventListener('change', function() {
                    const selectedValue = select.value;
                    if (selectedValue == '1') { //name값 설정해줘야 form data 안에 담길 수 있다 !
                        content.innerHTML = '<input type="date" style="width:200px;" id="startDate" name="start_date"> -' +
                                            '<select style="margin-left:10px; width:150px;" name="time_period"><option>선택하세요</option><option>오전</option><option>오후</option></select>';
                    } else {
                        content.innerHTML = '<input type="date" style="width:200px;" id="startDate" name="start_date"> - ' +
                                            '<input type="date" style="width:200px;" id="endDate" name="end_date">';
                    }

                    // 새롭게 생성된 요소를 가져와서 이벤트 리스너 추가
                    const start = document.getElementById('startDate');
                    const end = document.getElementById('endDate');
                    
                    if (end) {
                        end.addEventListener('change', function() {
                            if (start.value > end.value) {
                                alert('종료일이 시작일보다 빠릅니다.');
                                end.value = ''; 
                            }
                        });
                    }
                });
            
        </script>


		<script> /* 토스트 api 설정 */
		      const contentEditor = new toastui.Editor({
		      el: document.querySelector('#approval_edit'),
		      width: '100%',
		      height: '500px',
		      initialEditType: 'wysiwyg',
		      previewStyle: 'vertical',
		      hideModeSwitch: true
    		});
	    
		      function updateEditorContent() {
			        const selectElement = document.getElementById('category-select');
			        const selectedOption = selectElement.options[selectElement.selectedIndex];
			        const formContent = selectedOption.getAttribute('data-content');

			        // 토스트 에디터 내용 저장한 값 불러옴
			        contentEditor.setHTML(formContent);
			    }

			    // 페이지 로드 시 기본 내용 설정
			    document.addEventListener('DOMContentLoaded', () => {
			        updateEditorContent();
			    });
			
			    const form = document.getElementById("approvalForm");
			    form.addEventListener('submit', (e) => {
			        e.preventDefault();
			        const payload = new FormData(form);
			        const csrfToken = document.getElementById('csrf_token').value;
			   	
			     
			        /* 토스트 api 안에 값 저장 */
					const content = contentEditor.getHTML();
					payload.append("approval_content",content);

					payload.forEach((value, key) => {
					    console.log(`${key}: ${value}`);
					});
					
			        fetch('/approval_leave', {
			            method: 'POST',
			            headers: {
			                'X-CSRF-TOKEN': csrfToken
			            },
			            body: payload 
			        })
			        .then(response => response.json())
			        .then(data => {
			            console.log(data.res_msg);
			            if (data.res_code === '200') {
			                Swal.fire({
			                    icon: 'success',
			                    title: "성공",
			                    text: data.reg_msg
			                }).then(() => {
			                    location.href = "/approval/list?num=0";
			                });
			            } else {
			                Swal.fire({
			                    icon: 'error',
			                    title: '실패',
			                    text: data.reg_msg
			                });
			            }
			        })
			    });
			    
    	</script>
	</div>
</body>
</html>