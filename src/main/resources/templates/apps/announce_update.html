<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" data-sidebar="light">

<th:block layout:fragment="pagetitle">
	<!--page title-->
	<div th:replace="partials/title-meta :: title-meta('게시글 수정 페이지')"></div>
</th:block>

<head>
	<!-- Plugins css -->
	<link href="/assets/libs/dropzone/dropzone.css" rel="stylesheet" type="text/css" />
    <!--TOAST UI Editor CSS-->
    <link rel="stylesheet" type="text/css" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
</head>

<body>
	<div layout:fragment="content">
      <form id="announceUpdateForm" method="post" enctype="multipart/form-data">
		<div th:replace="partials/page-title :: page-title('게시글 수정','게시판')"></div>

		<div class="row">
			<div class="col-lg-8">
				<div class="card">
					<div class="card-body">
						<input type="hidden" id="csrf_token" th:value="${_csrf.token}">
						<input type="hidden" id="announce_no" th:value="${announceList.announce_no}">
						<input type="hidden" id="announce_writer" th:value="${announceList.announce_writer}">
						<input type="hidden" id="reg_date" th:value="${announceList.reg_date}">
						<div class="mb-3">
							<label class="form-label" for="announce_title">제목</label>
							<input type="text" class="form-control" id="announce_title"
							th:value="${announceList.announce_title}">
						</div>
						
							<label class="form-label">내용</label>
						        <!--TOAST UI Editor-->
						        <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
									
								<div id="announce_content" style="display: none;" th:text="${announceList.announce_content}"></div>
									
									<!-- TOAST UI Editor가 들어갈 div태그 -->
									    <div id="editor">
									    </div>
									    
								    <!-- TOAST UI Editor 생성 JavaScript 코드 -->
								    <script>
								        // 서버에서 렌더링된 HTML 콘텐츠를 가져오기
								        const content = document.querySelector('#announce_content').textContent;
								        const editor = new toastui.Editor({
								            el: document.querySelector('#editor'),
								            previewStyle: 'vertical',
								            height: '500px',
								            initialValue: content, // 서버에서 가져온 HTML 콘텐츠 설정
								            initialEditType: 'wysiwyg',
								            /* start of hooks */
			                                hooks: {
			                                    async addImageBlobHook(blob, callback) { // 이미지 업로드 로직 커스텀
			                                        try {
			                                            /*
			                                             * 1. 에디터에 업로드한 이미지를 FormData 객체에 저장
			                                             *    (이때, 컨트롤러 uploadEditorImage 메서드의 파라미터인 'image'와 formData에 append 하는 key('image')값은 동일해야 함)
			                                             */
			                                            const formData = new FormData();
			                                            formData.append('image', blob);

			                                            // 2. FileApiController - uploadEditorImage 메서드 호출
			                                            const csrfToken = document.getElementById("csrf_token").value;
			                                            const response = await fetch('/tui-editor/image-upload', {
			                                                method : 'POST',
			                                                body : formData,
			                                                headers: {
			                                         	       'X-CSRF-TOKEN': csrfToken

			                                                 },
			                                            });

			                                            // 3. 컨트롤러에서 전달받은 디스크에 저장된 파일명
			                                            const filename = await response.text();
			                                            console.log('서버에 저장된 파일명 : ', filename);

			                                            // 4. addImageBlobHook의 callback 함수를 통해, 디스크에 저장된 이미지를 에디터에 렌더링
			                                            const imageUrl = `/tui-editor/image-print?filename=${filename}`;
			                                            callback(imageUrl, 'image alt attribute');

			                                        } catch (error) {
			                                            console.error('업로드 실패 : ', error);
			                                        }
			                                    }
			                                }
			                                /* end of hooks */
								        });
								    </script>

					</div>
					<!-- end card body -->
				</div>
				<!-- end card -->

				<div class="card">
					<div class="card-header">
						<h5 class="card-title mb-0">첨부할 파일 목록</h5>
					</div>
					<div class="card-body">
						<div>
							<p class="text-muted">첨부할 파일을 이곳에 첨부하세요.</p>

								<div class="fallback">
									<input name="file" type="file" multiple="multiple">
									<div th:each="file : ${announceList.announceFile}">
									<span th:text="${file.fileOriName}"></span>     <!-- 파일 원본 정보 가져와서 삭제 누르면, 직접 삭제 가능하게 하기 -->
									</div>
								</div>
						</div>
					</div>
				</div>
				<!-- end card -->
			</div>
			
			<!-- end col -->
			<!-- 조직도 불러올 자리...radio로 권한 설정 클릭시 체크 가능하도록 ! -->
			<div class="col-lg-4">
				<div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">읽기 권한 설정</h5>
                    </div>
                    <div class="card-body" style="height:100%">
                        <div>
                            <label for="choices-privacy-status-input" class="form-label"></label>
                            <input type="radio" id="all" name="read_authority_status" value="N"><label for="all">전직원</label>
                            <input type="radio" id="select" name="read_authority_status" value="Y"><label for="select">권한 직접 설정</label>
                        </div>
                        <!-- 조직도를 표시할 div -->
						<div id="organization-chart" style="display: none;">
						    <!-- 조직도 내용이 동적으로 삽입할 예정 -->
						</div>
                    </div>
                </div>
				<!-- end card -->
				<div class="text-end mb-4">
					<button type="button" class="btn btn-danger w-sm">이전으로</button>
					<button type="submit" class="btn btn-success w-sm">수정 완료</button>
				</div>
			</div>
			<!-- end col -->
		</div>
	  </form>
	</div>



	<th:block layout:fragment="pagejs">
		<!-- dropzone js -->
		<script src="/assets/libs/dropzone/dropzone-min.js"></script>
		<!-- project-create init -->
 		<script src="/assets/js/pages/project-update.init.js"></script>

	</th:block>
</body>

</html>