<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" data-sidebar="light">

<th:block layout:fragment="pagetitle">
	<!--page title-->
	<div
		th:replace="~{partials/title-meta :: title-meta('Profile Settings')}"></div>
</th:block>

<head>
 <style>
        /* 모달 관련 CSS 수정 */
        .modal-dialog {
            margin: 0;  /* 여백 제거 */
            padding: 0; /* 패딩 제거 */
        }

        .modal-content {
            margin: 0;  /* 여백 제거 */
            padding: 0; /* 패딩 제거 */
        }

        /* 캔버스 크기 조정 및 불필요한 여백 제거 */
        #signatureCanvas {
            display: block;
            width: 100%;  /* 캔버스 크기를 모달에 맞게 */
            height: 200px;  /* 설정된 높이 유지 */
            margin: 0;
            padding: 0;
            border: none;  /* 불필요한 테두리 제거 */
            }
              /* 수정 가능한 필드 스타일 */
       .editable {
            background-color: #f8f9fa; /* 연한 회색 */
            border: 1px solid #ced4da;
        }
    </style>

</head>

<body>

	<div layout:fragment="content">
		<div class="position-relative mx-n4 mt-n4">
			<div class="profile-wid-bg profile-setting-img">
				<img src="/assets/images/profile-bg.jpg" class="profile-wid-img"
					alt="">
				<div class="overlay-content">
					<div class="text-end p-3">
						<div class="p-0 ms-auto rounded-circle profile-photo-edit">
							<input id="profile-foreground-img-file-input" type="file"
								class="profile-foreground-img-file-input"> <label
								for="profile-foreground-img-file-input"
								class="profile-photo-edit btn btn-light"> <i
								class="ri-image-edit-line align-bottom me-1"></i> Change Cover
							</label>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-xxl-3">
				<div class="card mt-n5">
					<div class="card-body p-4">
						<div class="text-center">
							<form action="/mypage/updateProfile" method="post"
								enctype="multipart/form-data">
								<div
									class="profile-user position-relative d-inline-block mx-auto mb-4">
									<!-- 프로필 이미지 동적 바인딩 -->
									<img
										th:src="${employee != null && employee.empProfilePicture != null ? employee.empProfilePicture : '/assets/images/users/avatar-1.jpg'}"
										class="rounded-circle avatar-xl img-thumbnail user-profile-image"
										alt="user-profile-image">
									<div class="avatar-xs p-0 rounded-circle profile-photo-edit">
										<input id="profile-img-file-input" type="file"
											class="profile-img-file-input" name="profileImage"> <label
											for="profile-img-file-input"
											class="profile-photo-edit avatar-xs"> <span
											class="avatar-title rounded-circle bg-light text-body">
												<i class="ri-camera-fill"></i>
										</span>
										</label>
									</div>
								</div>
							</form>
							<!-- 직원 정보 출력 (널 체크 추가) -->
							<h5 class="fs-16 mb-1"
								th:text="${employee != null ? employee.empName : '직원 이름 없음'}">직원
								이름 표시</h5>
							<p class="text-muted mb-0"
								th:text="${employee != null ? employee.deptNo + '팀 / ' + employee.jobNo : '직원 정보 없음'}">
								00팀 / 000 대리</p>
						</div>
					</div>
				</div>
				<!--end card-->
			</div>
			<!--end col-->
			<div class="col-xxl-9">
				<div class="card mt-xxl-n5">
					<div class="card-header">
						<ul
							class="nav nav-tabs-custom rounded card-header-tabs border-bottom-0"
							role="tablist">
							<li class="nav-item"><a class="nav-link active"
								data-bs-toggle="tab" href="#personalDetails" role="tab"> <i
									class="fas fa-home"></i> 개인정보
							</a></li>
							<li class="nav-item"><a class="nav-link"
								data-bs-toggle="tab" href="#changePassword" role="tab"> <i
									class="far fa-user"></i> 비밀번호 변경
							</a></li>
						</ul>
					</div>
					<div class="card-body p-4">
						<div class="tab-content">
							<div class="tab-pane active" id="personalDetails" role="tabpanel">
								<form action="/mypage" method="post">
									<div class="row">
										<div class="col-lg-6">
											<div class="mb-3">
												<label for="firstnameInput" class="form-label">이름</label> <input
													type="text" class="form-control" id="firstnameInput"
													name="empName"
													th:value="${employee != null ? employee.empName : ''}"
													readonly required>
											</div>
										</div>
										<!--end col-->
										<div class="col-lg-6">
											<div class="mb-3">
												<label for="empIdInput" class="form-label">사번</label> <input
													type="text" class="form-control" id="empIdInput"
													name="empId"
													th:value="${employee != null ? employee.empId : ''}"
													readonly required>
											</div>
										</div>
										<!--end col-->
										<div class="col-lg-6">
											<div class="mb-3">
												<label for="phonenumberInput" class="form-label">전화번호</label>
												<input type="text" class="form-control"
													id="phonenumberInput" name="empPhone"
													th:value="${employee != null ? employee.empPhone : ''}"
													readonly required>
											</div>
										</div>
										<!--end col-->
										<div class="col-lg-6">
											<div class="mb-3">
												<label for="ssnInput" class="form-label">주민등록번호</label> <input
													type="text" class="form-control" id="ssnInput"
													name="empSsn"
													th:value="${employee != null ? employee.empSsn : ''}"
													readonly>
											</div>
										</div>
										<!--end col-->

										<div class="col-lg-6">
											<div class="mb-3">
												<label for="addressInput" class="form-label">주소</label> <input
													type="text" class="form-control" id="addressInput"
													name="empAddress"
													th:value="${employee != null ? employee.empAddress : ''}"
													readonly required>
											</div>
										</div>
										<!--end col-->
										<div class="col-lg-6">
											<div class="mb-3">
												<label for="detailedAddressInput" class="form-label">상세주소</label>
												<input type="text" class="form-control"
													id="detailedAddressInput" name="empAddressDetail"
													th:value="${employee != null ? employee.empAddressDetail : ''}"
													readonly required>
											</div>
										</div>
										<!--end col-->
										<div class="col-lg-4">
											<div class="mb-3">
												<label for="hireDateInput" class="form-label">입사일</label> <input
													type="date" class="form-control" id="hireDateInput"
													name="empHire"
													th:value="${employee != null ? #dates.format(employee.empHire, 'yyyy-MM-dd') : ''}"
													readonly>
											</div>
										</div>
										<!--end col-->
										<div class="col-lg-4">
											<label for="signImageInput" class="form-label">서명이미지</label>
											<div class="input-group">
												<input type="text" class="form-control" id="signImageInput"
													name="signImage" placeholder="서명이미지 없음"  readonly>
												<button type="button" class="btn btn-primary btn-sm"
													data-bs-toggle="modal" data-bs-target="#flipModal">
													등록/수정</button>
											</div>
										</div>
										<!--end col-->
										<div id="flipModal" class="modal fade flip" tabindex="-1"
											aria-labelledby="flipModalLabel" aria-hidden="true">
											<div class="modal-dialog modal-dialog-centered">
												<div class="modal-content">
													<div class="modal-header">
														<h5 class="modal-title" id="flipModalLabel">서명 등록/수정</h5>
														<button type="button" class="btn-close"
															data-bs-dismiss="modal" aria-label="Close"></button>
													</div>
													<div class="modal-body">
														<!-- 서명 캔버스 추가 -->
														<canvas id="signatureCanvas" class="border"
															style="width: 100%; height: 200px;"></canvas>
														<input type="hidden" id="signatureImage"
															name="signatureImage">
														<button type="button" class="btn btn-secondary mt-2"
															onclick="clearCanvas()">지우기</button>
														
													</div>
													<div class="modal-footer">
														<button type="button" class="btn btn-light"
															data-bs-dismiss="modal">취소</button>
														<button type="button" class="btn btn-primary"
															data-bs-dismiss="modal" onclick="saveSignature()">
															등록</button>
													</div>
												</div>
											</div>
										</div>

										<div class="col-lg-12">
											<div class="hstack gap-2 justify-content-end">
												<div class="hstack gap-2 justify-content-end mt-3">
													<button type="button" id="editSaveButton" class="btn btn-primary" onclick="toggleEditSave()">수정</button>
												</div>

												
											</div>
										</div>
										<!--end col-->
									</div>
									<!--end row-->
								</form>
							</div>
							<!--end tab-pane-->

							<!-- 비밀번호 변경 탭 -->
							<div class="tab-pane" id="changePassword" role="tabpanel">
								<form action="/mypage/updatePassword" method="post">
									<div class="row g-2">
										<div class="col-lg-4">
											<div>
												<label for="oldpasswordInput" class="form-label">기존
													비밀번호</label> <input type="password" class="form-control"
													id="oldpasswordInput" name="oldPassword"
													placeholder="Enter current password">
											</div>
										</div>
										<div class="col-lg-4">
											<div>
												<label for="newpasswordInput" class="form-label">새
													비밀번호</label> <input type="password" class="form-control"
													id="newpasswordInput" name="newPassword"
													placeholder="Enter new password">
											</div>
										</div>
										<div class="col-lg-4">
											<div>
												<label for="confirmpasswordInput" class="form-label">비밀번호
													확인</label> <input type="password" class="form-control"
													id="confirmpasswordInput" name="confirmPassword"
													placeholder="Confirm new password">
											</div>
										</div>
										<div class="col-lg-12">
											<div class="text-end">
												<button type="submit" class="btn btn-success">비밀번호
													변경</button>
											</div>
										</div>
									</div>
								</form>
							</div>
							<!--end tab-pane-->

						</div>
					</div>
				</div>
			</div>
			<!--end col-->
		</div>
		<!--end row-->

	</div>

	<th:block layout:fragment="pagejs">

		<!-- profile-setting init js -->
		<script src="/assets/js/pages/profile-setting.init.js"></script>

		<script src="https://cdn.jsdelivr.net/npm/toastify-js" async></script>
		<script>
		
		const canvas = document.getElementById('signatureCanvas');
		const ctx = canvas.getContext('2d');
		let drawing = false;

		// 마우스 클릭 시 드로잉 시작
		canvas.addEventListener('mousedown', (event) => {
		    drawing = true;
		    const { x, y } = getCanvasCoordinates(event);
		    ctx.moveTo(x, y);  // 클릭한 즉시 선이 그려지도록 시작 좌표 설정
		});


		// 마우스 클릭 해제 시 드로잉 종료
		canvas.addEventListener('mouseup', () => {
		    drawing = false;
		    ctx.beginPath();  // 새로운 경로 시작
		});

		// 마우스 이동 시 그림 그리기
		canvas.addEventListener('mousemove', (event) => {
		    if (!drawing) return;
		    const { x, y } = getCanvasCoordinates(event);
		    ctx.lineTo(x, y);
		    ctx.stroke();
		    ctx.beginPath();
		    ctx.moveTo(x, y);
		});

		// 좌표 계산 함수 (스케일링 및 경계선 보정)
		function getCanvasCoordinates(event) {
		    const rect = canvas.getBoundingClientRect();
		    const bw = 5;  // 경계선 두께 (필요한 경우 수정 가능)

		    const x = (event.clientX - rect.left - bw) * (canvas.width / (rect.width - bw * 2));
		    const y = (event.clientY - rect.top - bw) * (canvas.height / (rect.height - bw * 2));

		    return { x, y };
		}


		// 캔버스 지우기
		function clearCanvas() {
		    ctx.clearRect(0, 0, canvas.width, canvas.height);
		}

		// 서명을 저장하는 함수 (Base64 인코딩)
		function saveSignature() {
    const dataURL = canvas.toDataURL('image/png');
    const formData = new FormData();
    formData.append('signatureImage', dataURL);  // 서명 이미지 Base64
    formData.append('empName', document.getElementById('firstnameInput').value);
    formData.append('empPhone', document.getElementById('phonenumberInput').value);
    formData.append('empAddress', document.getElementById('addressInput').value);
    formData.append('empAddressDetail', document.getElementById('detailedAddressInput').value);

    fetch('/mypage/updateProfile', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('signImageInput').value = data.filePath;
        } else {
            alert('서명 저장에 실패했습니다: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
		function toggleEditSave() {
		    const editableFields = [
		        document.getElementById('firstnameInput'),
		        document.getElementById('phonenumberInput'),
		        document.getElementById('addressInput'),
		        document.getElementById('detailedAddressInput')
		    ];

		    const editSaveButton = document.getElementById('editSaveButton');

		    if (editSaveButton.innerText === '수정') {
		        // 수정 가능하도록 설정
		       editableFields.forEach(field => {
						field.removeAttribute('readonly');
						field.classList.add('editable'); // 연한 회색 배경 적용
					});
		        // 버튼을 '저장'으로 변경
		        editSaveButton.innerText = '저장';
		    } else {
		        // 서버로 데이터 전송 (이때 fetch를 사용해서 전송합니다.)
		        const formData = new FormData();
		        formData.append('empName', document.getElementById('firstnameInput').value);
		        formData.append('empPhone', document.getElementById('phonenumberInput').value);
		        formData.append('empAddress', document.getElementById('addressInput').value);
		        formData.append('empAddressDetail', document.getElementById('detailedAddressInput').value);

		        fetch('/mypage/updateProfile', {
		            method: 'POST',
		            body: formData
		        })
		        .then(response => response.json())
		        .then(data => {
		            if (data.success) {
		                alert('저장되었습니다.');
		            } else {
		                alert('저장에 실패했습니다.');
		            }
		        })
		        .catch(error => {
		            console.error('Error:', error);
		        });

		     // 필드를 다시 읽기 전용으로 설정
                editableFields.forEach(field => {
                    field.setAttribute('readonly', true);	
                    field.classList.remove('editable'); // 연한 회색 제거
                });

		        // 버튼을 '수정'으로 변경
		        editSaveButton.innerText = '수정';
		    }
		}
		
		
		
		</script>

	</th:block>
</body>

</html>