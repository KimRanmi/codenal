<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}" data-sidebar="light">

<th:block layout:fragment="pagetitle">
	<!--page title-->
	<div th:replace="~{partials/title-meta :: title-meta('부서 관리')}"></div>
</th:block>

<head>
<!-- Font Awesome 라이브러리 추가 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<!-- jsTree 테마 CSS 포함 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
<!-- jQuery 포함 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
<!-- jsTree 포함 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.15/jstree.min.js"></script>

<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<style>
.jstree-icon.ri-building-fill { /* 회사 아이콘 */
	color: #3e4a6e;
	font-size: 24px;
}

.jstree-icon.ri-team-fill { /* 부서 아이콘 */
	color: #3577f1;
	font-size: 20px;
}

.jstree-icon.ri-user-2-fill { /* 직원 아이콘 */
	color: #9a9ba0;
	font-size: 16px;
}

.body-list { /* 몸통 높이 고정(동적X) */
	height: 598.5px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
	position: relative;
	padding-bottom: 60px;
}

.pagination { /* 페이징 위치 고정 */
	position: absolute;
	bottom: 10px;
	left: 50%;
	transform: translateX(-50%);
}
</style>
</head>

<body>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
    <title>Dashboard</title>
    <!-- Bootstrap CSS 및 기타 필요 CSS 포함 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 필요한 아이콘 라이브러리 추가 -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <!-- 추가 CSS 필요 시 포함 -->
</head>

<body>
    <div th:fragment="topbar" th:remove="tag">
        <header id="page-topbar">
            <div class="layout-width">
                <div class="navbar-header">
                    <div class="d-flex">
                        <!-- LOGO -->
                        <div class="navbar-brand-box horizontal-logo">
                            <a href="/" class="logo logo-dark">
                                <span class="logo-sm">
                                    <img src="/assets/images/logo-sm.png" alt="" height="22">
                                </span>
                                <span class="logo-lg">
                                    <img src="/assets/images/logo-dark.png" alt="" height="17">
                                </span>
                            </a>
                            <a href="/" class="logo logo-light">
                                <span class="logo-sm">
                                    <img src="/assets/images/logo-sm.png" alt="" height="22">
                                </span>
                                <span class="logo-lg">
                                    <img src="/assets/images/logo-light.png" alt="" height="17">
                                </span>
                            </a>
                        </div>

                        <!-- Hamburger Button -->
                        <button type="button" class="btn btn-sm px-3 fs-16 header-item vertical-menu-btn topnav-hamburger" id="topnav-hamburger-icon">
                            <span class="hamburger-icon">
                                <span></span>
                                <span></span>
                                <span></span>
                            </span>
                        </button>
                    </div>

                    <div class="d-flex align-items-center">
                        <!-- 추가적인 헤더 아이템들 -->

                        <!-- 알림 드롭다운 -->
                        <div class="dropdown topbar-head-dropdown ms-1 header-item" id="notificationDropdown">
                            <!-- 알림 아이콘 -->
                            <button type="button" class="btn btn-icon btn-topbar btn-ghost-secondary rounded-circle" id="page-header-notifications-dropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-haspopup="true" aria-expanded="false">
                                <i class='bx bx-bell fs-22'></i>
                                <span th:if="${#lists.size(alarms) > 0}" class="position-absolute topbar-badge fs-10 translate-middle badge rounded-pill bg-danger" th:text="${#lists.size(alarms)}">0</span>
                            </button>

                            <!-- 알림 드롭다운 메뉴 -->
                            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0" aria-labelledby="page-header-notifications-dropdown">
                                <!-- 드롭다운 헤더 -->
                                <div class="dropdown-head bg-primary bg-pattern rounded-top">
                                    <div class="p-3">
                                        <div class="row align-items-center">
                                            <div class="col">
                                                <h6 class="m-0 fs-16 fw-semibold text-white">알림</h6>
                                            </div>
                                            <div class="col-auto dropdown-tabs">
                                                <span class="badge badge-soft-light fs-13">
                                                    <span th:text="${#lists.size(alarms)}">0</span>개의 새로운 알림
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="px-2 pt-2">
                                        <ul class="nav nav-tabs dropdown-tabs nav-tabs-custom" data-dropdown-tabs="true" id="notificationItemsTab" role="tablist">
                                            <li class="nav-item waves-effect waves-light">
                                                <a class="nav-link active" data-bs-toggle="tab" href="#all-noti-tab" role="tab" aria-selected="true">전체 (<span th:text="${#lists.size(alarms)}">0</span>)</a>
                                            </li>
                                            <li class="nav-item waves-effect waves-light">
                                                <a class="nav-link" data-bs-toggle="tab" href="#messages-tab" role="tab" aria-selected="false">메세지</a>
                                            </li>
                                            <li class="nav-item waves-effect waves-light">
                                                <a class="nav-link" data-bs-toggle="tab" href="#alerts-tab" role="tab" aria-selected="false">Alerts</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- 드롭다운 내용 -->
                                <div class="tab-content position-relative" id="notificationItemsTabContent">
                                    <!-- 전체 알림 탭 -->
                                    <div class="tab-pane fade show active py-2 ps-2" id="all-noti-tab" role="tabpanel">
                                        <div data-simplebar style="max-height: 300px;" class="pe-2">
                                            <!-- 알림 리스트 반복 -->
                                            <div th:each="alarm : ${alarms}" class="text-reset notification-item d-block dropdown-item position-relative">
                                                <div class="d-flex">
                                                    <div class="avatar-xs me-3">
                                                        <span class="avatar-title bg-soft-info text-info rounded-circle fs-16">
                                                            <i class="bx bx-badge-check"></i>
                                                        </span>
                                                    </div>
                                                    <div class="flex-1">
                                                        <a th:href="@{'/meeting-room/reservations/' + ${alarm.alarmReferenceNo}}" class="stretched-link">
                                                            <h6 class="mt-0 mb-2 lh-base" th:text="${alarm.alarmTitle} + ' - ' + ${alarm.alarmContext}">알림 내용</h6>
                                                        </a>
                                                        <p class="mb-0 fs-11 fw-medium text-uppercase text-muted">
                                                            <span><i class="mdi mdi-clock-outline"></i> <span th:text="${#temporals.format(alarm.alarmCreateTime, 'yyyy-MM-dd HH:mm')}">시간</span></span>
                                                        </p>
                                                    </div>
                                                    <div class="px-2 fs-15">
                                                        <div class="form-check notification-check">
                                                            <input class="form-check-input" type="checkbox" th:id="'alarm-check-' + ${alarm.alarmNo}" th:data-alarm-no="${alarm.alarmNo}">
                                                            <label class="form-check-label" th:for="'alarm-check-' + ${alarm.alarmNo}"></label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- 알림 리스트 끝 -->

                                            <!-- 전체 보기 버튼 -->
                                            <div class="my-3 text-center view-all">
                                                <a th:href="@{/alarms}" class="btn btn-soft-success waves-effect waves-light">
                                                    View All Notifications <i class="ri-arrow-right-line align-middle"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 메세지 탭 -->
                                    <div class="tab-pane fade p-4" id="messages-tab" role="tabpanel" aria-labelledby="messages-tab"></div>
                                    <!-- Alerts 탭 -->
                                    <div class="tab-pane fade p-4" id="alerts-tab" role="tabpanel" aria-labelledby="alerts-tab"></div>
                                </div>
                            </div>
                        </div>
                        <!-- 알림 드롭다운 끝 -->

                        <!-- 전체화면 버튼 -->
                        <div class="ms-1 header-item d-none d-sm-flex">
                            <button type="button" class="btn btn-icon btn-topbar btn-ghost-secondary rounded-circle" data-toggle="fullscreen">
                                <i class='bx bx-fullscreen fs-22'></i>
                            </button>
                        </div>

                        <!-- 다크모드 토글 버튼 -->
                        <div class="ms-1 header-item d-none d-sm-flex">
                            <button type="button" class="btn btn-icon btn-topbar btn-ghost-secondary rounded-circle light-dark-mode">
                                <i class='bx bx-moon fs-22'></i>
                            </button>
                        </div>

                        <!-- 사용자 드롭다운 -->
                        <div class="dropdown ms-sm-3 header-item topbar-user">
                            <button type="button" class="btn" id="page-header-user-dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="d-flex align-items-center">
                                    <img class="rounded-circle header-profile-user" src="/assets/images/users/avatar-1.jpg" alt="Header Avatar">
                                    <span class="text-start ms-xl-2">
                                        <span class="d-none d-xl-inline-block ms-1 fw-medium user-name-text"> 하츄핑 <span>대리</span></span>
                                        <span class="d-none d-xl-block ms-1 fs-12 text-muted user-name-sub-text"> 웹 개발팀 </span>
                                    </span>
                                </span>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end">
                                <!-- 사용자 드롭다운 아이템 -->
                                <h6 class="dropdown-header">Welcome Anna!</h6>
                                <a class="dropdown-item" href="/pages-profile">
                                    <i class="mdi mdi-account-circle text-muted fs-16 align-middle me-1"></i> 
                                    <span class="align-middle">Profile</span>
                                </a>
                                <a class="dropdown-item" href="/chat">
                                    <i class="mdi mdi-message-text-outline text-muted fs-16 align-middle me-1"></i> 
                                    <span class="align-middle">Messages</span>
                                </a>
                                <a class="dropdown-item" href="/apps-tasks-kanban">
                                    <i class="mdi mdi-calendar-check-outline text-muted fs-16 align-middle me-1"></i> 
                                    <span class="align-middle">Taskboard</span>
                                </a>
                                <a class="dropdown-item" href="/pages-faqs">
                                    <i class="mdi mdi-lifebuoy text-muted fs-16 align-middle me-1"></i> 
                                    <span class="align-middle">Help</span>
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="/pages-profile">
                                    <i class="mdi mdi-wallet text-muted fs-16 align-middle me-1"></i> 
                                    <span class="align-middle">Balance : <b>$5971.67</b></span>
                                </a>
                                <a class="dropdown-item" href="/pages-profile-settings">
                                    <span class="badge bg-soft-success text-success mt-1 float-end">New</span>
                                    <i class="mdi mdi-cog-outline text-muted fs-16 align-middle me-1"></i> 
                                    <span class="align-middle">Settings</span>
                                </a>
                                <a class="dropdown-item" href="/auth-signin-basic">
                                    <i class="mdi mdi-logout text-muted fs-16 align-middle me-1"></i> 
                                    <span class="align-middle" data-key="t-logout">Logout</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Remove Notification Modal -->
        <div id="removeNotificationModal" class="modal fade zoomIn" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="NotificationModalbtn-close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mt-2 text-center">
                            <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#f7b84b,secondary:#f06548" style="width:100px;height:100px"></lord-icon>
                            <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                                <h4>Are you sure ?</h4>
                                <p class="text-muted mx-4 mb-0">Are you sure you want to remove this Notification ?</p>
                            </div>
                        </div>
                        <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                            <button type="button" class="btn w-sm btn-light" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn w-sm btn-danger" id="delete-notification">Yes, Delete It!</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 알림 읽음 상태 처리 JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const checkboxes = document.querySelectorAll('.notification-check .form-check-input');

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function(event) {
                    if (event.target.checked) {
                        const alarmNo = event.target.getAttribute('data-alarm-no');
                        fetch(`/api/alarms/${alarmNo}/read`, {
                            method: 'PUT'
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            // 알림 개수 업데이트
                            let badge = document.querySelector('.badge.bg-danger');
                            if (badge) {
                                let badgeCount = parseInt(badge.textContent);
                                badge.textContent = badgeCount > 0 ? badgeCount - 1 : 0;
                            }

                            // 알림 아이템 제거
                            const alarmItem = event.target.closest('.notification-item');
                            if (alarmItem) {
                                alarmItem.remove();
                            }
                        })
                        .catch(error => console.error('Error updating alarm:', error));
                    }
                });
            });
        });
    </script>

    <!-- Bootstrap JS 및 필요 JS 포함 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 추가 JS 필요 시 포함 -->
</body>

</html>


	<th:block layout:fragment="pagejs">

		<!-- <script src="/assets/libs/list.js/list.min.js"></script> -->
		<script src="/assets/libs/list.pagination.js/list.pagination.min.js"></script>
		<!-- <script src="/assets/js/pages/crm-contact.init.js"></script> -->
		<!-- icon -->
		<script src="/assets/js/pages/remix-icons-listing.js"></script>

		<script src="/assets/libs/prismjs/prism.js"></script>

		<script src="/assets/js/pages/form-validation.init.js"></script>

		<script src="/assets/libs/sweetalert2/sweetalert2.min.js"></script>
		<!-- Sweet alert init js-->
		<script src="/assets/js/pages/sweetalerts.init.js"></script>

		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

		<script>
		$(document).ready(function () {				
		    // 트리 메뉴
		    $.ajax({
		        url: '/admin/dept/tree-menu',
		        method: 'GET',
		        dataType: 'json',
		        success: function (data) {		
		        
		           /*  if (!data || data.length === 0) {
		                console.error('Received data is empty or undefined.');
		                return;
		            } */

		            // TreeMenuDto
		            const formatDataForJsTree = (nodes) => {
		                return nodes.map(node => {
		                    return {
		                        id: node.nodeId,
		                        text: node.nodeName,
		                        state: {
		                            opened: false	// 직원은 처음에 접어둠
		                        },
		                        children: node.nodeChildren ? formatDataForJsTree(node.nodeChildren) : [],						                    
		                        icon: node.nodeChildren && node.nodeChildren.length > 0 ? 'ri-team-fill' : 'ri-user-2-fill'
		                        		// 부서 아이콘 : 직원 아이콘
		                    };
		                });
		            };

		            const formattedData = formatDataForJsTree(data);

		            // 그룹웨어 회사 이름
		            const companyNode = {
		                id: 'companyName',
		                text: 'withXwork', // 위드워크 회사명
		                state: {
		                    opened: true
		                },
		                children: formattedData, 
		                icon: 'ri-building-fill' // 회사 아이콘
		            };

		            // jsTree 초기화
		            $('#treeMenu').jstree({
		                'core': {
		                    "animation": 0,
		                    "check_callback": false,
		                    'data': [companyNode] 
		                },
		                "plugins": ["types"],
		                "types": {
		                    "default": {
		                        "icon": "ri-team-fill"	// 부서 아이콘
		                    },
		                    "file": {
		                        "icon": "ri-user-2-fill"	// 직원 아이콘
		                    }
		                }
		            });
		        },
		       /*  error: function (xhr, status, error) {
		            console.error('Error loading tree menu data:', error);
		        } */
		    });
		});
		
		
		/* 부서 추가 모달 */
		document.getElementById('addDeptForm').addEventListener('submit', function(event) {
		    event.preventDefault(); 
		    
		    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
		    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
		
		    const deptName = document.querySelector('input[name="deptName"]').value;
		
		    fetch('/api/addDepartments', {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json',
		            [csrfHeader]: csrfToken
		        },
		        body: JSON.stringify({deptName}) 
		    })
		    .then(response => {
			    if (!response.ok) {
			    	// console.error('Response status:', response.status);
			        throw new Error('서버 응답에 문제가 있습니다.');
			    }
			    return response.json();
			})
			
		     .then(data => {
		        if (data.res_code === "200") {  // 성공 코드 체크
		            // SweetAlert2 창 띄우기
		            Swal.fire({
		                icon: 'success',
		                title: '부서 추가 성공',
		                text: '부서가 성공적으로 추가되었습니다.',
		                confirmButtonText: '확인'
		            }).then(() => {
		                location.reload();  // 목록을 새로고침하여 업데이트
		            });
		        } else {
		            // 실패 시 SweetAlert2 창 띄우기
		            Swal.fire({
		                icon: 'error',
		                title: '부서 추가 실패',
		                text: data.res_msg || '부서 추가에 실패했습니다.',
		                confirmButtonText: '확인'
		            });
		        }
		    })

		    .catch(error => {
		        console.error('에러 발생:', error);
		        alert('서버와 통신 중 에러가 발생했습니다.');
		    });
		});

		</script>

	</th:block>



</body>

</html>
