<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}" data-sidebar="light">

<th:block layout:fragment="pagetitle">
	<!--page title-->
	<div th:replace="~{partials/title-meta :: title-meta('부서 관리')}"></div>
</th:block>

<head>
<!-- Font Awesome 라이브러리 추가 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<!-- jsTree 테마 CSS 포함 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
<!-- jQuery 포함 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
<!-- jsTree 포함 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.15/jstree.min.js"></script>

<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<style>
.jstree-icon.ri-building-fill { /* 회사 아이콘 */
	color: #3e4a6e;
	font-size: 24px;
}

.jstree-icon.ri-team-fill { /* 부서 아이콘 */
	color: #3577f1;
	font-size: 20px;
}

.jstree-icon.ri-user-2-fill { /* 직원 아이콘 */
	color: #9a9ba0;
	font-size: 16px;
}

.body-list { /* 몸통 높이 고정(동적X) */
	height: 598.5px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
	position: relative;
	padding-bottom: 60px;
}

.pagination { /* 페이징 위치 고정 */
	position: absolute;
	bottom: 10px;
	left: 50%;
	transform: translateX(-50%);
}
</style>
</head>

<body>
	<div id="zoomInModal" class="modal fade zoomIn" tabindex="-1" aria-labelledby="zoomInModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header bg-light p-3">
					<h5 class="modal-title" id="exampleModalLabel">임시 비밀번호 발급</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="close-modal"></button>
					<div class="mb-3"></div>
				</div>

				<form class="was-validated" autocomplete="off" id="addDeptForm">
					<div class="modal-body">
						<h5 class="fs-16">
							<span th:text="${employeeDetail.empName}"></span>님에게 임시 비밀번호를 발급하시겠습니까?
						</h5>
						<div class="mb-3">
							<label for="customername-field" class="form-label" style="font-size: 15px;">관리자 비밀번호</label> <span class="text-danger">*</span> <input type="password" class="form-control" id="adminPasswordInput" placeholder="비밀번호를 입력하세요." required autocomplete="new-password" />
							<div class="invalid-feedback"></div>
						</div>
					</div>
					<input type="hidden" id="employeeIdHiddenInput" th:value="${employeeDetail.empId}">
					<div class="modal-footer">
						<div class="hstack gap-2 justify-content-end">
							<button type="submit" class="btn btn-primary btn-md" id="sa-basic">발급</button>
						</div>
					</div>
				</form>

			</div>
		</div>
	</div>

	<th:block layout:fragment="pagejs">

		<!-- <script src="/assets/libs/list.js/list.min.js"></script> -->
		<script src="/assets/libs/list.pagination.js/list.pagination.min.js"></script>
		<!-- <script src="/assets/js/pages/crm-contact.init.js"></script> -->
		<!-- icon -->
		<script src="/assets/js/pages/remix-icons-listing.js"></script>

		<script src="/assets/libs/prismjs/prism.js"></script>

		<script src="/assets/js/pages/form-validation.init.js"></script>

		<script src="/assets/libs/sweetalert2/sweetalert2.min.js"></script>
		<!-- Sweet alert init js-->
		<script src="/assets/js/pages/sweetalerts.init.js"></script>

		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

		<script>
		$(document).ready(function () {				
		    // 트리 메뉴
		    $.ajax({
		        url: '/admin/dept/tree-menu',
		        method: 'GET',
		        dataType: 'json',
		        success: function (data) {		
		        
		           /*  if (!data || data.length === 0) {
		                console.error('Received data is empty or undefined.');
		                return;
		            } */

		            // TreeMenuDto
		            const formatDataForJsTree = (nodes) => {
		                return nodes.map(node => {
		                    return {
		                        id: node.nodeId,
		                        text: node.nodeName,
		                        state: {
		                            opened: false	// 직원은 처음에 접어둠
		                        },
		                        children: node.nodeChildren ? formatDataForJsTree(node.nodeChildren) : [],						                    
		                        icon: node.nodeChildren && node.nodeChildren.length > 0 ? 'ri-team-fill' : 'ri-user-2-fill'
		                        		// 부서 아이콘 : 직원 아이콘
		                    };
		                });
		            };

		            const formattedData = formatDataForJsTree(data);

		            // 그룹웨어 회사 이름
		            const companyNode = {
		                id: 'companyName',
		                text: 'withXwork', // 위드워크 회사명
		                state: {
		                    opened: true
		                },
		                children: formattedData, 
		                icon: 'ri-building-fill' // 회사 아이콘
		            };

		            // jsTree 초기화
		            $('#treeMenu').jstree({
		                'core': {
		                    "animation": 0,
		                    "check_callback": false,
		                    'data': [companyNode] 
		                },
		                "plugins": ["types"],
		                "types": {
		                    "default": {
		                        "icon": "ri-team-fill"	// 부서 아이콘
		                    },
		                    "file": {
		                        "icon": "ri-user-2-fill"	// 직원 아이콘
		                    }
		                }
		            });
		        },
		       /*  error: function (xhr, status, error) {
		            console.error('Error loading tree menu data:', error);
		        } */
		    });
		});
		
		
		/* 부서 추가 모달 */
		document.getElementById('addDeptForm').addEventListener('submit', function(event) {
		    event.preventDefault(); 
		    
		    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
		    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
		
		    const deptName = document.querySelector('input[name="deptName"]').value;
		
		    fetch('/api/addDepartments', {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json',
		            [csrfHeader]: csrfToken
		        },
		        body: JSON.stringify({deptName}) 
		    })
		    .then(response => {
			    if (!response.ok) {
			    	// console.error('Response status:', response.status);
			        throw new Error('서버 응답에 문제가 있습니다.');
			    }
			    return response.json();
			})
			
		     .then(data => {
		        if (data.res_code === "200") {  // 성공 코드 체크
		            // SweetAlert2 창 띄우기
		            Swal.fire({
		                icon: 'success',
		                title: '부서 추가 성공',
		                text: '부서가 성공적으로 추가되었습니다.',
		                confirmButtonText: '확인'
		            }).then(() => {
		                location.reload();  // 목록을 새로고침하여 업데이트
		            });
		        } else {
		            // 실패 시 SweetAlert2 창 띄우기
		            Swal.fire({
		                icon: 'error',
		                title: '부서 추가 실패',
		                text: data.res_msg || '부서 추가에 실패했습니다.',
		                confirmButtonText: '확인'
		            });
		        }
		    })

		    .catch(error => {
		        console.error('에러 발생:', error);
		        alert('서버와 통신 중 에러가 발생했습니다.');
		    });
		});

		</script>

	</th:block>



</body>

</html>
