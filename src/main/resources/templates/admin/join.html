<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" data-sidebar="light">

<th:block layout:fragment="pagetitle">
	<!--page title-->
	<div th:replace="partials/title-meta :: title-meta('직원 정보 관리')"></div>
</th:block>

<head>
 	<!-- Cleave.js CDN 추가 -->
   <script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>
     <!-- flatpickr CSS 추가 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- flatpickr JS 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
      <!-- SweetAlert2 CSS 추가 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- SweetAlert2 JS 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
	<div layout:fragment="content">
		<div th:replace="partials/page-title :: page-title('직원 정보 관리','직원 관리')"></div>
		<div class="row">
			<div class="col-lg-12">
				<div class="card">
				<input type="hidden" id="csrf_token" th:value="${_csrf.token}">
					<form id="employeeAddFrm" class="was-validated" method="POST">
						<div class="card-header">
							<h5 class="card-title mb-0">신규 직원 등록</h5>
						</div>
						<div class="card-body">
							<div class="row g-4">
							
							<!-------------------- 이름 + 사번---------------------->
								<div class="col-lg-6">
									<div>
										<label for="admin-new-name" class="form-label" name="emp_name">이름<span
												class="text-danger">*</span></label>
										<input type="text" class="form-control" id="admin-new-name" 
												placeholder="이름을 입력하세요." required />
										<div class="invalid-feedback">필수 정보</div>
									</div>
								</div>
								<div class="col-lg-6">
									<div>
										<label for="admin-new-id" class="form-label" name="emp_id">사번<span 
											class="text-danger"></span></label>
										<input type="text" class="form-control" id="admin-new-id" disabled />
									</div>
								</div>
							<!-------------------- 개인 번호 + 주민 등록 번호 ---------------------->
								<div class="col-lg-6">
									<div>
										<label for="admin-new-phone" class="form-label" name="emp_phone">개인 번호<span
												class="text-danger">*</span></label>
										<input type="text" class="form-control" id="admin-new-phone" 
												placeholder="번호를 입력하세요. (숫자만)" required>
										<div class="invalid-feedback">필수 정보</div>
									</div>
								</div>
								<div class="col-lg-6">
									<div>
										<label for="admin-new-ssn" class="form-label" name="emp_ssn">주민 등록 번호<span
												class="text-danger">*</span></label>
										<input type="text" class="form-control" id="admin-new-ssn" 
												placeholder="주민 등록 번호를 입력하세요. (숫자만)" required />		
										<div class="invalid-feedback">필수 정보</div>
									</div>
								</div>
			
							<!-------------------- 주소 + 상세 주소 ---------------------->
								<div class="col-md-6">
									<div>
										<label for="admin-new-address" class="form-label" name="emp_address">주소 <span
												class="text-danger"></span></label>
										<input type="text" class="form-control" id="admin-new-address"
											placeholder="주소를 검색하세요." />		
									</div>
								</div>
								<div class="col-md-6">
									<div>
										<label for="admin-new-address-detail" class="form-label" name="emp_address_detail">상세 주소 <span
												class="text-danger"></span></label>
										<input type="text" class="form-control" id="admin-new-address-detail"
											placeholder="상세 주소를 입력하세요" />		
									</div>
								</div>
								
							<!-------------------- 부서 + 직급 ---------------------->
								<div class="col-md-6">
								    <div>
								        <label for="admin-new-dept" class="form-label" name="dept_no">부서</label>
								        <input type="text" class="form-control" id="admin-new-dept"
											placeholder="부서를 입력하세요" />		
								        <!-- <select name="deptCode" id="dept" class="form-select">
								            <option value="">부서를 선택하세요.</option>
								        </select>
								        <div class="invalid-feedback">필수 정보</div> -->
								    </div>
								</div>

								<div class="col-md-6">
									<div>
										<label for="admin-new-job" class="form-label" name="job_no">직급</label>
										 <input type="text" class="form-control" id="admin-new-job"
											placeholder="직급을 입력하세요" />		
										<div class="invalid-feedback">필수 정보</div>
									</div>
								</div>
								
							<!-------------------- 입사일 + 퇴사일 ---------------------->
								 <div class="col-lg-6">
                                    <div>
                                        <label for="admin-new-hire" class="form-label">입사일 <span
                                                class="text-danger">*</span></label>
                                      	<input type="text" class="form-control" id="admin-new-hire" name="emp_hire"
                                            data-provider="flatpickr" data-date-format="Y-m-d"
                                            placeholder="입사일을 선택하세요." required /> 
                                        <div class="invalid-feedback">필수 정보</div>
                                    </div>
                                </div>
								<div class="col-lg-6">
									<div>
										<label for="admin-new-end" class="form-label">퇴사일 <span
												class="text-danger"></span></label>
										<input type="text" class="form-control" id="admin-new-end" disabled />		
									</div>
								</div>
							<!-------------------- 완료 + 취소 ---------------------->
								<div class="col-lg-12">
									<div class="hstack justify-content-end gap-2">
										<input type="submit" class="btn btn-primary" value="등록">
										<button type="button" class="btn btn-ghost-danger"><i
												class="ri-close-line align-bottom"></i> 취소</button>
									</div>
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>


	<th:block layout:fragment="modal">

	</th:block>

	<th:block layout:fragment="pagejs">

	<script>
	/* 	개인 번호 (000-0000-0000) */
	if (document.querySelector("#admin-new-phone")) {
	    var cleaveBlocks = new Cleave('#admin-new-phone', {
	        delimiters: ['-', '-'],
	        blocks: [3, 4, 4]
	    });
	}
	
	/* 주민 등록 번호 (000000-0000000) */
	if (document.querySelector("#admin-new-ssn")) {
	    var cleaveBlocks = new Cleave('#admin-new-ssn', {
	        delimiters: ['-', '-'],
	        blocks: [6, 7]
	    });
	}
	
	/* 필수 정보 경고 */
	 (function () {
		'use strict';
		window.addEventListener('load', function () {
			var forms = document.getElementsByClassName('needs-validation');
			if (forms)
				var validation = Array.prototype.filter.call(forms, function (form) {
					form.addEventListener('submit', function (event) {
						if (form.checkValidity() === false) {
							event.preventDefault();
							event.stopPropagation();
						}
						form.classList.add('was-validated');
					}, false);
				});
		}, false);
	})(); 
	
	/* 입사일 선택 */
	flatpickr("#admin-new-hire", {
	    dateFormat: "Y-m-d",  // DB에서 요구하는 형식으로 설정 (YYYY-MM-DD)
	    allowInput: true
	});

	/* 폼 제출 시 데이터 전송 */
	const form = document.getElementById("employeeAddFrm");
	form.addEventListener('submit', (e) => {
	    e.preventDefault();
	
	    let vali_check = true;  // 이 값을 기본으로 true로 설정하여 검증 통과 전부 확인
	    let vali_text = "";
	
	    const emp_name = document.getElementById("admin-new-name").value;
	    const emp_phone = document.getElementById("admin-new-phone").value;
	    const emp_ssn = document.getElementById("admin-new-ssn").value;
	    const dept_no = document.getElementById("admin-new-dept").value;
	    const job_no = document.getElementById("admin-new-job").value;
	    const emp_hire = document.getElementById("admin-new-hire").value;
	    
	    if (emp_name === '') {
	        vali_text = "이름을 입력하세요";
	        vali_check = false;
	    } else if (emp_phone === '') {
	        vali_text = "번호를 입력하세요";
	        vali_check = false;
	    } else if (emp_ssn === '') {
	        vali_text = "주민 등록 번호를 입력하세요";
	        vali_check = false;
	    } else if (dept_no === '') {
	        vali_text = "부서를 선택하세요";
	        vali_check = false;
	    } else if (job_no === '') {
	        vali_text = "직급을 선택하세요";
	        vali_check = false;
	    } else if (emp_hire === '') {
	        vali_text = "입사일을 선택하세요";
	        vali_check = false;
	    }
	
	    if (!vali_check) {
	        Swal.fire({
	            icon: 'error',
	            title: '실패',
	            text: vali_text,
	            confirmButtonText: "닫기"
	        });
	        return;
	    }
	
	    // 서버로 전송할 데이터 객체
	    const emp_auth = 'USER';  // 직원 USER 고정 NULL 안 되게 해놓기
	    const obj = {
		    empName: emp_name,
		    empPhone: emp_phone,
		    empSsn: emp_ssn,
		    deptNo: dept_no,
		    jobNo: job_no,
		    empHire: emp_hire,
		    empAuth: emp_auth
		};

	
	    const jsonData = JSON.stringify(obj);
	    const csrfToken = document.getElementById("csrf_token").value;
	
	    fetch('/join', {
	        method: 'POST',
	        headers: {
	            "Content-Type": "application/json;charset=utf-8",
	            "Accept": "application/json",
	            'X-CSRF-TOKEN': csrfToken
	        },     
	        body: jsonData
	    })
	  
	        
	    .then(response => response.json())
	    .then(data => {
	        if (data.res_code === '200') {
	            Swal.fire({
	                icon: 'success',
	                title: '성공',
	                text: data.res_msg,
	                confirmButtonText: "닫기"
	            }).then(() => {
	                location.href = "/board";
	            });
	        } else {
	            Swal.fire({
	                icon: 'error',
	                title: '실패',
	                text: data.res_msg,
	                confirmButtonText: "닫기"
	            });
	        }
	       
	    });
	});
	</script>
	</th:block>
</body>

</html>