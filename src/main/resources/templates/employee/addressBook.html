<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" data-sidebar="light">

<th:block layout:fragment="pagetitle">
	<!--page title-->
	<div th:replace="~{partials/title-meta :: title-meta('주소록')}"></div>
</th:block>

<head>
	<!-- Font Awesome 라이브러리 추가 -->
	 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> 
	<!-- jsTree 테마 CSS 포함 -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
	<!-- jQuery 포함 -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
	<!-- jsTree 포함 -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.15/jstree.min.js"></script>
 <style>
        .jstree-icon.ri-building-fill { /* 회사 아이콘 */
            color: #3e4a6e; 
            font-size: 24px;
        }
        .jstree-icon.ri-team-fill { /* 부서 아이콘 */
            color: #3577f1; 
            font-size: 20px;
        }
        .jstree-icon.ri-user-2-fill { /* 직원 아이콘 */
            color: #9a9ba0; 
            font-size: 16px;
        }
    </style>
</head>

<body>
	<div layout:fragment="content">
		<div th:replace="~{partials/page-title :: page-title('조직도', '주소록')}"></div>
		<div class="row">
			<!--------------------------------- 조직도 ----------------------------------------------->
			<div class="col-xxl-3">
				<div class="card" id="contact-view-detail">
					<!-- 조직도 이름 -->
					<div class="card-header border-0">
						<div class="col-sm">
							<h5 class="card-title mb-0"
								style="font-size: 18px; font-weight: 900;">조직도</h5>
						</div>
					</div>
					<!-- JsTree -->
					<div class="card-body border border-dashed border-end-0 border-start-0">
						<div id="treeMenu"></div>				
					</div>
				</div>
			</div>

			<!---------------------------------주소록 목록----------------------------------------------->
			<div class="col-xxl-9">
				<div class="card" id="contactList">
					<!----------목록 이름------------>
					<div class="card-header border-0">
						<div class="col-sm">
							<h5 class="card-title mb-0"
								style="font-size: 18px; font-weight: 900;">직원 목록</h5>
						</div>
					</div>

					<!----------목록 상단------------>
					<div
						class="card-body border border-dashed border-end-0 border-start-0">
						<!-- 검색 폼 searchDto != null 시작 -->
						<form th:action="@{/employee/addressBook}"
							th:object="${searchDto}" method="get"
							th:if="${searchDto != null}">
							<div class="row g-3 justify-content-end">
								<div class="col-md-2">
									<div>
										<select class="form-select mb-3"
											aria-label="Default select example" name="search_type"
											id="idPayment" th:field="*{search_type}">
											<option th:value="1"
												th:selected="${searchDto.search_type} == '1'"
												style="color: #999999;">전체</option>
											<option th:value="2"
												th:selected="${searchDto.search_type} == '3'">직원명</option>
											<option th:value="3"
												th:selected="${searchDto.search_type} == '4'">부서명</option>
											<option th:value="4"
												th:selected="${searchDto.search_type} == '5'">직급명</option>
											<option th:value="5"
												th:selected="${searchDto.search_type} == '6'">전화번호</option>
										</select>
									</div>
								</div>
								<div class="col-md-4">
									<div class="search-box">
										<input type="text" class="form-control search"
											name="search_text" th:field="*{search_text}"
											placeholder="검색어를 입력해 주세요."> <i
											class="ri-search-line search-icon"></i>
									</div>
								</div>
								
								<!-- 검색 버튼 -->
								<div class="col-md-1">
									<div>
										<button type="submit" class="btn btn-primary w-100"
											style="font-size: 18px; padding: 3px;">검색</button>
									</div>
								</div>
							</div>
						</form>						
						<!-- 검색 폼 끝 -->
						
						<!-- 검색 폼 searchDto == null 시작 -->
						<form th:action="@{/employee/addressBook}" method="get"
							th:if="${searchDto == null}">
							<div class="row g-3 justify-content-end">
								<div class="col-md-2">
									<div>
										<select class="form-select mb-3"
											aria-label="Default select example" name="search_type"
											id="idPayment">
											<option th:value="1" style="color: #999999;">전체</option>
											<option th:value="2">직원명</option>
											<option th:value="3">부서명</option>
											<option th:value="4">직급명</option>
											<option th:value="5">전화번호</option>
										</select>
									</div>
								</div>
								<div class="col-md-4">
									<div class="search-box">
										<input type="text" class="form-control search"
											name="search_text" placeholder="검색어를 입력해 주세요."> <i
											class="ri-search-line search-icon"></i>
									</div>
								</div>
								
								<!-- 검색 버튼 -->
								<div class="col-md-1">
									<div>
										<button type="submit" class="btn btn-primary w-100"
											style="font-size: 18px; padding: 3px;">검색</button>
									</div>
								</div>
							</div>
						</form>
						<!-- 검색 폼 끝 -->
					</div>

					<!----------목록 조회------------>
					<div class="card-body">
						<div>
							<div class="table-responsive table-card mb-3">
								<table class="table align-middle table-nowrap mb-0"
									id="customerTable">
									<thead class="table-light">
										<tr>
											<th scope="col" style="text-align: center;">번호</th>
											<th scope="col" style="text-align: center;">직원명</th>
											<th scope="col" style="text-align: center;">부서명</th>
											<th scope="col" style="text-align: center;">직급명</th>
											<th scope="col" style="text-align: center;">전화번호</th>
										</tr>
									</thead>
									<tbody>
										<!-- 직원 목록이 비어 있을 때 -->
										<th:block th:if="${#lists.isEmpty(resultList.content)}">
											<tr>
												<td colspan="6" style="text-align: center;">직원 목록이
													없습니다.</td>
											</tr>
										</th:block>
										<!-- 직원 목록 표시 -->
										<th:block th:if="${!#lists.isEmpty(resultList.content)}">
											<tr th:each="employee, employeeStat : ${resultList.content}">									
												<td th:text="${(resultList.pageable.pageSize)*(resultList.pageable.pageNumber)+employeeStat.count}"
													style="text-align: center;"></td>
												<td th:text="${employee.empName}"
													style="text-align: center;"></td>
												<td th:text="${employee.deptName}"
													style="text-align: center;"></td>
												<td th:text="${employee.jobName}"
													style="text-align: center;"></td>
												<td th:text="${employee.empPhone}"
													style="text-align: center;"></td>
										</th:block>
									</tbody>
								</table>
								
								<br>
								
								<div class="center" th:if="${!resultList.isEmpty()}" id="pagination-container">
									<div class="pagination"
										th:with="
										pageNumber = ${resultList.pageable.pageNumber},
										pageSize = ${resultList.pageable.pageSize},
										totalPages = ${resultList.totalPages},
										startPage = ${T(java.lang.Math).floor(pageNumber / pageSize) * pageSize + 1},
										tempEndPage = ${startPage + pageSize - 1},
										endPage = (${tempEndPage < totalPages ? tempEndPage : totalPages})
										">
										<th:block th:if="${!resultList.first}">
											<a th:href="${resultList.first} ? '#' : @{/admin/list(page=${pageNumber - 1},search_text=${searchDto.search_text},search_type=${searchDto.search_type})}">&lt;</a>
										</th:block>
									
										<th:block
											th:each="page: ${#numbers.sequence(startPage, endPage)}">
											<a th:text="${page}"
												th:href="@{/admin/list(page=${page} - 1,search_text=${searchDto.search_text},search_type=${searchDto.search_type})}"
												th:classappend="${page == pageNumber + 1} ? 'active'">1</a>
										</th:block>
										<th:block th:if="${!resultList.last}">
											<a th:href="${resultList.last} ? '#' : @{/admin/list(page=${pageNumber + 1},search_text=${searchDto.search_text},search_type=${searchDto.search_type})}">&gt;</a>
										</th:block>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<th:block layout:fragment="pagejs">
	
		<!-- <script src="/assets/libs/list.js/list.min.js"></script> -->
		<script src="/assets/libs/list.pagination.js/list.pagination.min.js"></script>
		<!-- <script src="/assets/js/pages/crm-contact.init.js"></script> -->
		<!-- icon -->
		<script src="/assets/js/pages/remix-icons-listing.js"></script>
		
		<script>
		$(document).ready(function () {				
		    // 트리 메뉴 데이터
		    $.ajax({
		        url: '/employee/addressBook/tree-menu',
		        method: 'GET',
		        dataType: 'json',
		        success: function (data) {		
		        	
		           /*  if (!data || data.length === 0) {
		                console.error('Received data is empty or undefined.');
		                return;
		            } */

		            // TreeMenuDto
		            const formatDataForJsTree = (nodes) => {
		                return nodes.map(node => {
		                    return {
		                        id: node.nodeId,
		                        text: node.nodeName,
		                        state: {
		                            opened: false	// 직원은 처음에 접어둠
		                        },
		                        children: node.nodeChildren ? formatDataForJsTree(node.nodeChildren) : [],						                    
		                        icon: node.nodeChildren && node.nodeChildren.length > 0 ? 'ri-team-fill' : 'ri-user-2-fill'
		                        		// 부서 아이콘 : 직원 아이콘
		                    };
		                });
		            };

		            const formattedData = formatDataForJsTree(data);

		            // 그룹웨어 회사 이름
		            const companyNode = {
		                id: 'companyName',
		                text: 'withXwork', // 위드워크 회사명
		                state: {
		                    opened: true
		                },
		                children: formattedData, 
		                icon: 'ri-building-fill' // 회사 아이콘
		            };

		            // jsTree 초기화
		            $('#treeMenu').jstree({
		                'core': {
		                    "animation": 0,
		                    "check_callback": false,
		                    'data': [companyNode] 
		                },
		                "plugins": ["types"],
		                "types": {
		                    "default": {
		                        "icon": "ri-team-fill"	// 부서 아이콘
		                    },
		                    "file": {
		                        "icon": "ri-user-2-fill"	// 직원 아이콘
		                    }
		                }
		            });
		        },
		       /*  error: function (xhr, status, error) {
		            console.error('Error loading tree menu data:', error);
		        } */
		    });
		});
		</script> 
						
	</th:block>
	


</body>

</html>
